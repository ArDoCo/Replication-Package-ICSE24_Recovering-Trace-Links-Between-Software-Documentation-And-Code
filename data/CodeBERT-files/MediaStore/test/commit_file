commit_id,summary,diff,files,commit_time
Implementation/mediastore.ejb.packaging/src/edu/kit/ipd/sdq/mediastore/ejb/packaging/PackagingImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.packaging;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.ListIterator;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.ejb.Stateless;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IPackagingLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IPackagingRemote;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

/**
 * Session Bean implementation class Packaging
 */

@Stateless
public class PackagingImpl extends BaseEJB implements IPackagingRemote, IPackagingLocal {

    /**
     *
     */
    private static final long serialVersionUID = 7507720547495222404L;

    static final int BUFFER = 2048;

    /**
     * Default constructor.
     */
    public PackagingImpl() {
    	super();
    	ejbName = ""packaging"";
    }

    private static void addFileToZip(final ZipOutputStream zos, final String szName, final FileContent content) throws Exception {
        ZipEntry entry;
        entry = new ZipEntry(szName);
        zos.putNextEntry(entry);

        // copy byte array (file content) into input stream
        InputStream is = null;
        if (content.isLocal()) {
        	FileContentLocal localContent = (FileContentLocal) content;
        	is = Files.newInputStream(localContent.getPath());
        }
        else {
        	FileContentRemote remoteContent = (FileContentRemote) content;
        	is = new ByteArrayInputStream(remoteContent.getBytes());
        }

        final byte[] buf = new byte[8000];
        int nLength;
        while (true) {
            nLength = is.read(buf);
            if (nLength < 0) {
                break;
            }
            zos.write(buf, 0, nLength);
        }

        is.close();
        zos.closeEntry();
    }

    @Override
    public FileContent zip(final List<AudioFile> fileList, final boolean localCall) {

    	
        OutputStream outputStream = null;
        Path filePath = null;
        if (!localCall) { //if the files are not locally located (i.e. are remote) 
        	outputStream = new ByteArrayOutputStream();
        } 
        else {
        	filePath = Paths.get(FSUtil.getTempFileName(""Packaging"", ""zip""));
        	try {
				outputStream = Files.newOutputStream(filePath);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
        }
        try {

            // creates a ZipOutputStream object, to which we pass the output stream we wish to write to
            final ZipOutputStream zipOut = new ZipOutputStream(outputStream);

            for (final ListIterator<AudioFile> i = fileList.listIterator(); i.hasNext();) {

                // get next AudioFile and moving forward in List
                final AudioFile audioFileToAdd = i.next();

                addFileToZip(zipOut, audioFileToAdd.getFilename(), audioFileToAdd.getContent());
            }

            zipOut.close();

        } catch (final Exception e) { 
            e.printStackTrace();
        }

        if (!localCall) {
        	return new FileContentRemote(((ByteArrayOutputStream) outputStream).toByteArray());
        }
        else {
        	return new FileContentLocal(filePath);
        }
        	
    }
}"
Implementation/mediastore.ejb.userdbadapter/src/edu/kit/ipd/sdq/mediastore/ejb/userdbadapter/UserDBAdapterImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.userdbadapter;

import javax.ejb.EJB;
import javax.ejb.Stateless;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserDBAdapterLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserDBAdapterRemote;

/**
 * @author Anastasia @date: 09.12.2014
 */

@Stateless
public class UserDBAdapterImpl extends BaseEJB implements IUserDBAdapterRemote, IUserDBAdapterLocal {

    /**
	 * 
	 */
	private static final long serialVersionUID = -36797393228502249L;
	@EJB
    DbManager dbManager;
    
    public UserDBAdapterImpl() {
		super();
		ejbName = ""userdbadapter"";
	}
    
    @Override
    public Long addUser(final UserRegData userData) throws UserAlreadyExistsException {
//        System.out.println(""Remote"");
        return this.dbManager.saveUser(userData);
    }

    @Override
    public CurrentUser getUserData(final String username, final String password) throws BadLoginDataException {
//        System.out.println(""Server: UserAdapterImpl.login()"");
        return this.dbManager.findUser(username, password);
    }

    @Override
    public void removeAllData() {
        this.dbManager.clearTable();
    }
}"
Implementation/mediastore.ejb.userdbadapter/src/edu/kit/ipd/sdq/mediastore/ejb/userdbadapter/DbManager.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.userdbadapter;

import java.util.List;

import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;

/**
 * @author Anastasia @date: 06.12.2014
 */
@Stateless
public class DbManager {

    @PersistenceContext(name = ""Mediastore"")
    private EntityManager em;

    public Long saveUser(final UserRegData userData) throws UserAlreadyExistsException {

//        System.out.println(""DbManager.saveUser()"");

        boolean userExists = this.em.createNamedQuery(""findByEmail"", User.class)
                .setParameter(""email"", userData.getEmail()).getResultList().isEmpty();
        userExists = false; // TODO: Remove me after performance tests
        if (!userExists) {

            final User user = new User(userData.getFirstname(), userData.getLastname(), userData.getEmail(),
                    userData.getPassword());
            this.em.persist(user);
            this.em.flush(); // make possible to get id
            return user.getId();

        } else {
            throw new UserAlreadyExistsException(userData.getEmail());
        }

    }

    public CurrentUser findUser(final String username, final String password) throws BadLoginDataException {

        final List<User> users = this.em.createNamedQuery(""findByEmail"", User.class).setParameter(""email"", username)
                .getResultList();

        if (!users.isEmpty()) {
            final User u = users.get(0);
            return new CurrentUser(u.getId(), u.getFirstname(), u.getLastname(), u.getEmail(), u.getPassword());
        }
        throw new BadLoginDataException();
    }

    public void clearTable() {
        this.em.createNamedQuery(""clear"").executeUpdate();
    }
}"
Implementation/mediastore.ejb.userdbadapter/src/edu/kit/ipd/sdq/mediastore/ejb/userdbadapter/User.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.userdbadapter;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.TableGenerator;

@Entity
@NamedQueries({ @NamedQuery(name = ""clear"", query = ""DELETE FROM User""),
        @NamedQuery(name = ""findAll"", query = ""SELECT e FROM User e""),
        @NamedQuery(name = ""findByEmail"", query = ""SELECT e FROM User e WHERE e.email = :email"") })
@TableGenerator(name = ""user"")
public class User implements Serializable {

    private static final long serialVersionUID = -7332870302408416956L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String firstname;

    @Column(nullable = false)
    private String lastname;

    @Column(nullable = false)
    private String email;

    @Column(nullable = false)
    private String password; // TODO: should be passwordHash

    public User() {
    }

    public User(final String firstname, final String lastname, final String email, final String password) {
        super();
        this.setFirstname(firstname);
        this.setLastname(lastname);
        this.setEmail(email);
        this.setPassword(password);
    }

    public String getFirstname() {
        return this.firstname;
    }

    public void setFirstname(final String firstname) {
        this.firstname = firstname;
    }

    public String getLastname() {
        return this.lastname;
    }

    public void setLastname(final String lastname) {
        this.lastname = lastname;
    }

    public String getEmail() {
        return this.email;
    }

    public void setEmail(final String email) {
        this.email = email;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(final String password) {
        this.password = password;
    }

    public Long getId() {
        return this.id;
    }

    public void setId(final Long id) {
        this.id = id;
    }

    @Override
    public String toString() {
        return ""User [id="" + this.id + "", firstname="" + this.firstname + "", lastname="" + this.lastname + "", email=""
                + this.email + "", password="" + this.password + ""]"";
    }

}"
Implementation/mediastore.ejb.facade/src/edu/kit/ipd/sdq/mediastore/ejb/facade/FacadeImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.facade;

import java.rmi.RemoteException;
import java.util.List;

import javax.ejb.Stateless;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacadeLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacadeRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaManagement;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserManagement;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

/**
 * @author Anastasia
 */

@Stateless
public class FacadeImpl extends BaseEJB implements IFacadeRemote, IFacadeLocal {

    private static final long serialVersionUID = 308982198674607428L;

    IUserManagement userManagement;

    IMediaManagement mediaManagement;

//    /*
//     * Funktioniert nur mit den local EJB!!!
//     *
//     * @EJB(lookup=""ejb/UserAdapterImpl"")
//     *  private IUserDBAdapter userAdapter;
//     */
//    @PostConstruct
//    public void init() {
//        /*
//         * JNDI wird in GlassFish console als external JNDI resource definiert!
//         *
//         * InitialContext ctx = new InitialContext();
//         * IUserDBAdapter userAdapter = (IUserDBAdapter) ctx.lookup(""ejb/UserAdapterImpl"");
//         */
//    }

    public FacadeImpl() {
		super();
		ejbName = ""facade"";
	}
    
    private void initMediaManager() {
    	this.mediaManagement = initRequiredInterface(""IMediaManagement"", IMediaManagement.class);
    }

    private void initUserManagement() {
        this.userManagement = initRequiredInterface(""IUserManagement"", IUserManagement.class);
    }

    @Override
    public Long register(final UserRegData user) throws UserAlreadyExistsException, NamingException {
        this.initUserManagement();
        return this.userManagement.register(user);
    }

    @Override
    public CurrentUser login(final String username, final String password) throws BadLoginDataException,
            NamingException {
        this.initUserManagement();
        return this.userManagement.login(username, password);
    }

    @Override
    public Long upload(AudioFile file)  throws FailedUploadException, NamingException, RemoteException {
        this.initMediaManager();
        FileContent content = file.getContent();
        String fileName = file.getUploader() + file.getFilename() + ""Facade-MM"";
        file.setContent(content.convertIfNeeded(isLocal(""IMediaManagement""), fileName, ""mp3""));
        return this.mediaManagement.upload(file);
    }

    @Override
    public List<AudioFileInfo> getFileList() throws NamingException {
        this.initMediaManager();
        return this.mediaManagement.getFileList();
    }

    @Override
    public void downloadTest(final List<Long> id, final List<Integer> bitrates, final String downloaderLogin)
            throws FailedDownloadException, NamingException {
        this.initMediaManager();
        final FileContentRemote content = (FileContentRemote) this.mediaManagement.download(id, bitrates, downloaderLogin, isLocal(""IMediaManagement""));
        
        content.getBytes().equals(""42""); // prevent optimization
    }

    @Override
    public FileContent download(final List<Long> id, final List<Integer> bitrates, final String downloaderLogin, final boolean localCall)
            throws FailedDownloadException, NamingException {
    	
        System.out.println(""Bitrates "" + bitrates.toString());
        this.initMediaManager();
        FileContent content = this.mediaManagement.download(id, bitrates, downloaderLogin, isLocal(""IMediaManagement""));

        String fileName = downloaderLogin + ""Facade-Download"";
        content = content.convertIfNeeded(localCall, fileName, FSUtil.getExtension(id.size()));
        return content;
         
        
    }
	
}"
Implementation/mediastore.ejb.usermanagement/ejbModule/edu/kit/ipd/sdq/mediastore/ejb/usermanagement/SecurityUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.usermanagement;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.util.Arrays;
import java.util.Base64;
import java.util.Base64.Decoder;
import java.util.Base64.Encoder;

/**
 * @author Anastasia @date: 07.12.2014
 */
public class SecurityUtil {

    private static final String HASH_ALGORITHMUS = ""SHA-512"";
    private static final String CHARSET = ""UTF-8"";

    /*
     * Algorithm: 
     * 1. Generate Secure random: Salt 
     * 2. Hashing password with Salt (salted hash): SHA-512 
     * 3. Salt added to hash(the last 10 Bytes) 
     * 4. Password will be saved in DB as: Salted hash + Salt
     */
    public static String computeHash(final String string) {

        byte[] bytesOfMessage;
        byte[] hash;
        final byte[] salt = getSalt(10);

        MessageDigest md;

        try {
            bytesOfMessage = string.getBytes(CHARSET);
            md = MessageDigest.getInstance(HASH_ALGORITHMUS);
            md.reset();
            md.update(salt);
            md.update(bytesOfMessage);
            hash = md.digest();
            final byte[] t = concatenate(hash, salt);
            return base64FromBytes(t);
        } catch (UnsupportedEncodingException | NoSuchAlgorithmException e) {
            e.printStackTrace();
        }
        return null;
    }

    public static String computeHash(final String string, final byte[] salt) {
        byte[] bytesOfMessage;
        byte[] hash;
        try {
            bytesOfMessage = string.getBytes(CHARSET);
            MessageDigest md;
            md = MessageDigest.getInstance(HASH_ALGORITHMUS);
            md.reset();
            md.update(salt);
            md.update(bytesOfMessage);
            hash = md.digest();
            final byte[] t = concatenate(hash, salt);
            return base64FromBytes(t);
        } catch (UnsupportedEncodingException | NoSuchAlgorithmException e) {
            e.printStackTrace();
        }
        return null;
    }

    private static byte[] getSalt(final int length) {
        final SecureRandom random = new SecureRandom();
        final byte bytes[] = new byte[length];
        random.nextBytes(bytes);
        return bytes;
    }

    /*
     * Compare password from login form with password from DB
     */
    public static Boolean isEqual(final String loginPassword, final String dbPassword) {
        try {
            final byte[] dbPass = bytesFrombase64(dbPassword);
            final byte[] salt = Arrays.copyOfRange(dbPass, dbPass.length - 10, dbPass.length);
            final String tempPass = computeHash(loginPassword, salt);
            
//            System.err.println(String.format(""SecurityUtil.isEqual: plain:%s, hashed:%s, db:%s"", loginPassword, tempPass, dbPassword));
            if (dbPassword.equals(tempPass)) {
                return true;
            }

        } catch (final IOException e) {
            e.printStackTrace();
        }
        return false;
    }

    private static String base64FromBytes(final byte[] text) {
        // final BASE64Encoder encoder = new BASE64Encoder();
        // return encoder.encode(text);
        Encoder encoder = Base64.getMimeEncoder();
        String hash = new String(encoder.encode(text), StandardCharsets.UTF_8);
        // https://stackoverflow.com/questions/35301409/is-java-8-java-util-base64-a-drop-in-replacement-for-sun-misc-base64
        if (hash.length() == 76) {
            return hash + ""\n"";
        }
        return hash;
    }

    private static byte[] bytesFrombase64(final String text) throws IOException {
        // byte[] textBytes = null;
        // final BASE64Decoder decoder = new BASE64Decoder();
        // textBytes = decoder.decodeBuffer(text);
        Decoder decoder = Base64.getMimeDecoder();
        byte[] textBytes = decoder.decode(text);
        return textBytes;
    }

    private static byte[] concatenate(final byte[] a, final byte[] b) {
        final int lengthA = a.length;
        final int lengthB = b.length;
        final byte[] concat = new byte[lengthA + lengthB];
        System.arraycopy(a, 0, concat, 0, lengthA);
        System.arraycopy(b, 0, concat, lengthA, lengthB);
        return concat;
    }
}"
Implementation/mediastore.ejb.usermanagement/ejbModule/edu/kit/ipd/sdq/mediastore/ejb/usermanagement/UserManagementImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.usermanagement;

import javax.ejb.Stateless;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserDBAdapter;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserManagementLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IUserManagementRemote;

@Stateless
public class UserManagementImpl extends BaseEJB implements IUserManagementRemote, IUserManagementLocal {

    /**
	 * 
	 */
	private static final long serialVersionUID = 7408460010804803257L;
	private IUserDBAdapter userAdapter;

    public UserManagementImpl() {
		super();
		ejbName = ""usermanagement"";
	}
    private void initUserAdapter() throws NamingException {
    	this.userAdapter = initRequiredInterface(""IUserDBAdapter"", IUserDBAdapter.class);
    }
 
    @Override
    public Long register(final UserRegData user) throws UserAlreadyExistsException, NamingException {
        this.initUserAdapter();
        final String passwordHash = SecurityUtil.computeHash(user.getPassword());
        user.setPassword(passwordHash);
        return this.userAdapter.addUser(user);
    }

    @Override
    public CurrentUser login(final String username, final String password) throws BadLoginDataException,
            NamingException {
        this.initUserAdapter();
        final CurrentUser user = this.userAdapter.getUserData(username, password);
        
//        System.err.println(String.format(""Login with plain:%s, db:%s"", password, user.getPasswordHash()));
        boolean isEqualPassword = SecurityUtil.isEqual(password, user.getPasswordHash()).booleanValue();
        if (!isEqualPassword) {
            throw new BadLoginDataException();
        }
        return user;
    }

}"
Implementation/mediastore.ejb.mediamanagement/src/edu/kit/ipd/sdq/mediastore/ejb/mediamanagement/MediaManagementImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.mediamanagement;

import java.rmi.RemoteException;
import java.util.List;

import javax.ejb.Stateless;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownload;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaAccess;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaManagementLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaManagementRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IPackaging;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

/**
 * @author Anastasia
 */
@Stateless
public class MediaManagementImpl extends BaseEJB implements IMediaManagementRemote, IMediaManagementLocal {

    private static final long serialVersionUID = -8294016625795719929L;

    IDownload nextInDowloadChain;
    IMediaAccess mediaAccess;
    IPackaging packaging;

	public MediaManagementImpl() {
		super();
		ejbName = ""mediamanagement"";
	}

    private void initMediaAccess() {
    	this.mediaAccess = initRequiredInterface(""IMediaAccess"", IMediaAccess.class);
    }

    private void initNext() {
        this.nextInDowloadChain = initRequiredInterface(""IDownload"", IDownload.class);
    }

    
    private void initPackaging() {
    	this.packaging = initRequiredInterface(""IPackaging"", IPackaging.class);
    }

    @Override
    public Long upload(AudioFile file)  throws FailedUploadException, NamingException, RemoteException {
        this.initMediaAccess();
        FileContent content = file.getContent();
        String fileName = file.getUploader() + file.getFilename() + ""MM-MA"";
        file.setContent(content.convertIfNeeded(isLocal(""IMediaAccess""), fileName, ""mp3""));
        return this.mediaAccess.upload(file);
    }

    @Override
    public List<AudioFileInfo> getFileList() throws NamingException {
        this.initMediaAccess();
        return this.mediaAccess.getFileList();
    }

    @Override
    public FileContent download(final List<Long> requestedAudioIDs, final List<Integer> bitrates,
            final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

        if (requestedAudioIDs.size() != bitrates.size()) {
            throw new RuntimeException(""Number of requested audios ("" + requestedAudioIDs.size()
                    + "") does not equal number of bitrates ("" + bitrates.size() + ')');
        }

//        System.out.println(""MediaManagerImpl.download()"" + requestedAudioIDs);

        this.initNext();
        final List<AudioFile> audioFiles = this.nextInDowloadChain.download(requestedAudioIDs, bitrates,
                downloaderLogin, isLocal(""IDownload""));
//        System.out.println(""MediaManagerImpl. AudioFile count:"" + audioFiles.size());

        FileContent content;
        int size = audioFiles.size();
        if (size == 1) {
            content = audioFiles.get(0).getContent();
        } else {
            this.initPackaging();
            boolean localPackaging = isLocal(""IPackaging"");
            for (AudioFile audioFile : audioFiles) {
                String fileName = downloaderLogin + audioFile.getFilename() + ""MM-Packaging"";
                FileContent audioFileContent = audioFile.getContent();
                audioFile.setContent(audioFileContent.convertIfNeeded(localPackaging, fileName, ""mp3""));
            }
            content = this.packaging.zip(audioFiles, localPackaging);
        }
        
        String fileName = downloaderLogin + ""MM-Facade"";
        content = content.convertIfNeeded(localCall, fileName, FSUtil.getExtension(size));
        
        return content;
    }


}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/BaseEJB.java,"package edu.kit.ipd.sdq.mediastore.basic;

import java.util.HashMap;
import java.util.Map;

import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.config.Config;
import edu.kit.ipd.sdq.mediastore.basic.config.EJB;
import edu.kit.ipd.sdq.mediastore.basic.config.InterfaceDetails;
import edu.kit.ipd.sdq.mediastore.basic.config.ProvidedInterface;
import edu.kit.ipd.sdq.mediastore.basic.config.RequiredInterface;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IBusinessInterface;
import edu.kit.ipd.sdq.mediastore.basic.utils.JNDIUtil;

public abstract class BaseEJB {
	protected String ejbName = """";
	protected Map<String, InterfaceDetails> loadedInterfaces;
	protected EJB ejb;
	public BaseEJB() {
		loadedInterfaces = new HashMap<String, InterfaceDetails>();
	}

	protected <T extends IBusinessInterface> T initRequiredInterface(String requiredInterface, Class<T> type) {
		if (!Config.isReconfigurable() &&  Config.getEJBs() != null) { // if reconfiguration is not allowed, and ejbs was already initialized
			InterfaceDetails details = loadedInterfaces.get(requiredInterface);
			return type.cast(details.getBusinessInterface());
		}
		System.out.println(ejbName + "" trying to load config"");
		Config.loadConfig();
		ejb = Config.getEJBs().get(ejbName);
		RequiredInterface ri = ejb.getRequiredInterface(requiredInterface); //e.g IDownload
		ProvidedInterface pi = ri.getProvidedInterface(); //interface to load, e.g IDownloadMediaAccess
		
		
		if (loadedInterfaces.containsKey(requiredInterface)) { //If the required interface is already loaded
			InterfaceDetails details = loadedInterfaces.get(requiredInterface);
			ProvidedInterface loadedInterface = details.getProvidedInterface();
			EJB loadedEJB = details.getEJB();
			
			if(ejb.equals(loadedEJB)) { // if both ejbs are the same (same name, host, port, jndiName)
				if (loadedInterface.getName().equals(pi.getName())) { //If there's a match between the config and the loaded interface
		        	System.out.println(""JNDI lookup unnecessary, returning loaded interface "" + loadedInterface.getName());
					return type.cast(details.getBusinessInterface());
					
				}
			}
		}

		//Otherwise make a lookup
		EJB callee = pi.getProvidingEJB();
		boolean localCall = ejb.getAppName().equals(callee.getAppName()) && ejb.getHost().equals(callee.getHost());
		Object response = new Object();
		try {
			System.out.println(""JNDI Lookup for "" + pi.getName());
			response = JNDIUtil.find(pi, localCall);
		} catch (NamingException e) {
			e.printStackTrace();
		}

		T result = type.cast(response);

		loadedInterfaces.put(requiredInterface, new InterfaceDetails(result, pi, ejb, localCall));

		return result;

	}
	
	protected boolean isLocal(String interfaceName) {
		return loadedInterfaces.get(interfaceName).isLocal();
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/BadLoginDataException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * @author Anastasia
 */
public class BadLoginDataException extends AppException {

    private static final long serialVersionUID = 7146754211447615073L;

    public BadLoginDataException() {
        super(""Falscher Benutzername oder Passwort"");
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/PropertiesException.java,"package edu.kit.ipd.sdq.mediastore.basic.exceptions;

public class PropertiesException extends AppException {

    private static final long serialVersionUID = 8722508008622524418L;

    public PropertiesException(final String message, final Throwable cause) {
        super(message, cause);
    }

    public PropertiesException(final String message) {
        super(message);
    }
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/UserAlreadyExistsException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * @author Anastasia
 */
public class UserAlreadyExistsException extends DbException {

    private static final long serialVersionUID = 7146754211447615073L;

    public UserAlreadyExistsException(final String email) {
        super(""User with email = "" + email + "" existiert schon."");
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/FailedDownloadException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * @author Anastasia
 */
public class FailedDownloadException extends AppException {

    private static final long serialVersionUID = 7146754211447615073L;

    public FailedDownloadException(final String fileName) {
        super(""AudioFile "" + fileName + "" wurde nicht gefunden."");
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/AppException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

public abstract class AppException extends Exception {

    private static final long serialVersionUID = 7771681117904612651L;

    public AppException() {
    }

    public AppException(final String message) {
        super(message);
    }

    public AppException(final String message, final Throwable cause) {
        super(message, cause);
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/FailedUploadException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * @author Anastasia
 */
public class FailedUploadException extends AppException {

    private static final long serialVersionUID = 7146754211447615073L;

    public FailedUploadException(final String file, final Throwable inner) {
        super(""Fehler beim  Speichern des Audios "" + file, inner);
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/DbException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

public abstract class DbException extends AppException {

    private static final long serialVersionUID = -8199177260966839133L;

    public DbException() {
    }

    public DbException(final String message) {
        super(message);
    }

    public DbException(final String message, final Throwable cause) {
        super(message, cause);
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/UnknownServerException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * @author Anastasia
 */
public class UnknownServerException extends AppException {

    private static final long serialVersionUID = 1882523006071507619L;

    public UnknownServerException() {
        super(""Unknown server ERROR"");
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/exceptions/ConversionException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.exceptions;

/**
 * This exception is thrown if a file conversion fails
 *
 * @author Amine Kechaou
 *
 */
public class ConversionException extends AppException {

    private static final long serialVersionUID = -6664912801770270513L;

    public ConversionException(final String message) {
        super(message);
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadAudioWatermarkingRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IDownloadAudioWatermarkingRemote extends IDownloadAudioWatermarking {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IPackaging.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.util.List;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;

public interface IPackaging extends IBusinessInterface {

    FileContent zip(List<AudioFile> fileList, boolean localCall);
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserManagementLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IUserManagementLocal extends IUserManagement {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadTagWatermarking.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

public interface IDownloadTagWatermarking extends IDownload {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadTagWatermarkingRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IDownloadTagWatermarkingRemote extends IDownloadTagWatermarking {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IPackagingRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IPackagingRemote extends IPackaging {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccessLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IMediaAccessLocal extends IMediaAccess {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadAudioWatermarkingLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IDownloadAudioWatermarkingLocal extends IDownloadAudioWatermarking {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadCache.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface IDownloadCache extends IDownload {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadCacheLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IDownloadCacheLocal extends IDownloadCache {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccess.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.rmi.RemoteException;
import java.util.List;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;

public interface IMediaAccess extends IBusinessInterface {

	Long upload(AudioFile file)  throws FailedUploadException, RemoteException;

    List<AudioFileInfo> getFileList();
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccessRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IMediaAccessRemote extends IMediaAccess {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaManagementRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IMediaManagementRemote extends IMediaManagement {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadMediaAccess.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface IDownloadMediaAccess extends IDownload {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/ICacheMaintenanceRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface ICacheMaintenanceRemote extends ICacheMaintenance {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadMediaAccessRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IDownloadMediaAccessRemote extends IDownloadMediaAccess {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccessMaintenance.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface IMediaAccessMaintenance extends IBusinessInterface {

    void removeAllData();

    boolean trimToPayload(long payloadUserId, int payloadSize) throws Exception;
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadTagWatermarkingLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IDownloadTagWatermarkingLocal extends IDownloadTagWatermarking {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaManagementLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IMediaManagementLocal extends IMediaManagement {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccessMaintenanceRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IMediaAccessMaintenanceRemote extends IMediaAccessMaintenance {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserDBAdapter.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;

public interface IUserDBAdapter extends IBusinessInterface {

    Long addUser(UserRegData user) throws UserAlreadyExistsException;

    CurrentUser getUserData(String username, String password) throws BadLoginDataException;

    void removeAllData();
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IFacade.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.rmi.RemoteException;
import java.util.List;

import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;

public interface IFacade extends IBusinessInterface {

    public Long register(UserRegData user) throws UserAlreadyExistsException, NamingException;

    public CurrentUser login(String username, String password) throws BadLoginDataException, NamingException;

    public List<AudioFileInfo> getFileList() throws NamingException;

    void downloadTest(List<Long> id, List<Integer> bitrates, String downloaderLogin) throws FailedDownloadException,
            NamingException;
    
    public Long upload(AudioFile file) throws FailedUploadException, NamingException, RemoteException;

    public FileContent download(List<Long> id, List<Integer> bitrates, String downloaderLogin, boolean local)
            throws FailedDownloadException, NamingException;
    
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserDBAdapterLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IUserDBAdapterLocal extends IUserDBAdapter {
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserDBAdapterRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IUserDBAdapterRemote extends IUserDBAdapter {
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IBusinessInterface.java,"package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.io.Serializable;

public interface IBusinessInterface extends Serializable {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadMediaAccessLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IDownloadMediaAccessLocal extends IDownloadMediaAccess {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/ICacheMaintenance.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface ICacheMaintenance extends IBusinessInterface {

    public void clear();
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownload.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.util.List;

import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;

public interface IDownload extends IBusinessInterface {

    public List<AudioFile> download(List<Long> requestedAudioIDs, List<Integer> bitrates, String downloaderLogin, boolean local)
            throws FailedDownloadException, NamingException;

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadCacheRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IDownloadCacheRemote extends IDownloadCache {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadAudioWatermarking.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface IDownloadAudioWatermarking extends IDownload {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadReEncoder.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;


public interface IDownloadReEncoder extends IDownload {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserManagement.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;

public interface IUserManagement extends IBusinessInterface {

    Long register(UserRegData user) throws UserAlreadyExistsException, NamingException;

    CurrentUser login(String username, String password) throws BadLoginDataException, NamingException;

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IFacadeLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IFacadeLocal extends IFacade {


}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadReEncoderRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IDownloadReEncoderRemote extends IDownloadReEncoder {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaManagement.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import java.rmi.RemoteException;
import java.util.List;

import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;

public interface IMediaManagement extends IBusinessInterface {

	public Long upload(AudioFile file)  throws FailedUploadException, NamingException, RemoteException;

    public List<AudioFileInfo> getFileList() throws NamingException;

    public FileContent download(List<Long> requestedAudioIDs, List<Integer> bitrates, String downloaderLogin, boolean localCall)
            throws FailedDownloadException, NamingException;
    

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IUserManagementRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IUserManagementRemote extends IUserManagement {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IFacadeRemote.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Remote;

@Remote
public interface IFacadeRemote extends IFacade {


}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IMediaAccessMaintenanceLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IMediaAccessMaintenanceLocal extends IMediaAccessMaintenance {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IPackagingLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IPackagingLocal extends IPackaging {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/ICacheMaintenanceLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface ICacheMaintenanceLocal extends ICacheMaintenance {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/interfaces/IDownloadReEncoderLocal.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.interfaces;

import javax.ejb.Local;

@Local
public interface IDownloadReEncoderLocal extends IDownloadReEncoder {

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/Main.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import com.thoughtworks.xstream.XStream;

public class Main {

	public static void main(String[] args) throws IOException {
		Map<String, EJB> ejbs = new HashMap<String, EJB>();

		EJB audiowatermarking = new EJB(""audiowatermarking"", ""localhost"", ""3700"", ""mediastore.ear.audiowatermarking"", ""mediastore.ejb.audiowatermarking"", ""AudioWatermarkingImpl"");
		EJB cache = new EJB(""cache"", ""localhost"", ""3700"", ""mediastore.ear.cache"", ""mediastore.ejb.cache"", ""CacheImpl"");
		EJB facade = new EJB(""facade"", ""localhost"", ""3700"", ""mediastore.ear.facade"", ""mediastore.ejb.facade"", ""FacadeImpl"");
		EJB mediaaccess = new EJB(""mediaaccess"", ""localhost"", ""3700"", ""mediastore.ear.mediaaccess"", ""mediastore.ejb.mediaaccess"", ""MediaAccessImpl"");
		EJB mediamanagement = new EJB(""mediamanagement"", ""localhost"", ""3700"", ""mediastore.ear.mediamanagement"", ""mediastore.ejb.mediamanagement"", ""MediaManagementImpl"");
		EJB packaging = new EJB(""packaging"", ""localhost"", ""3700"", ""mediastore.ear.packaging"", ""mediastore.ejb.packaging"", ""PackagingImpl"");
		EJB reencoder = new EJB(""reencoder"", ""localhost"", ""3700"", ""mediastore.ear.reencoder"", ""mediastore.ejb.reencoder"", ""ReEncoderImpl"");
		EJB tagwatermarking = new EJB(""tagwatermarking"", ""localhost"", ""3700"", ""mediastore.ear.tagwatermarking"", ""mediastore.ejb.tagwatermarking"", ""TagWatermarkingImpl"");
		EJB userdbadapter = new EJB(""userdbadapter"", ""localhost"", ""3700"", ""mediastore.ear.userdbadapter"", ""mediastore.ejb.userdbadapter"", ""UserDBAdapterImpl"");
		EJB usermanagement = new EJB(""usermanagement"", ""localhost"", ""3700"", ""mediastore.ear.usermanagement"", ""mediastore.ejb.usermanagement"", ""UserManagementImpl"");
		EJB webbean = new EJB(""webbean"", ""localhost"", ""3700"", """", """", """");
		
		//IDownloadAudioWatermarking
		ProvidedInterface idownloadaudiowatermarking = new ProvidedInterface(""audiowatermarking"", ""IDownloadAudioWatermarking"");
		audiowatermarking.addProvidedInterface(idownloadaudiowatermarking);
		
		//IDownloadCache
		ProvidedInterface idownloadcache = new ProvidedInterface(""cache"", ""IDownloadCache"");
		cache.addProvidedInterface(idownloadcache);
		
		//ICacheMaintenance
		ProvidedInterface icachemaintenance = new ProvidedInterface(""cache"", ""ICacheMaintenance"");
		cache.addProvidedInterface(icachemaintenance);
		
		//IFacade
		ProvidedInterface ifacade = new ProvidedInterface(""facade"", ""IFacade"");
		facade.addProvidedInterface(ifacade);
		
		
		//IMediaAccess
		ProvidedInterface imediaaccess = new ProvidedInterface(""mediaaccess"", ""IMediaAccess"");
		mediaaccess.addProvidedInterface(imediaaccess);
		
		//IDownloadMediaAccess
		ProvidedInterface idownloadmediaaccess = new ProvidedInterface(""mediaaccess"", ""IDownloadMediaAccess"");
		mediaaccess.addProvidedInterface(idownloadmediaaccess);
		
		
		//IMediaAccessMaintenance
		ProvidedInterface imediaaccessmaintenance = new ProvidedInterface(""mediaaccess"", ""IMediaAccessMaintenance"");
		mediaaccess.addProvidedInterface(imediaaccessmaintenance);
		

		//IMediaManagement
		ProvidedInterface imediamanagement = new ProvidedInterface(""mediamanagement"", ""IMediaManagement"");
		mediamanagement.addProvidedInterface(imediamanagement);
		
		//IPackaging
		ProvidedInterface ipackaging = new ProvidedInterface(""packaging"", ""IPackaging"");
		packaging.addProvidedInterface(ipackaging);
		
		//IDownloadReencoder
		ProvidedInterface idownloadreencoder = new ProvidedInterface(""reencoder"", ""IDownloadReencoder"");
		reencoder.addProvidedInterface(idownloadreencoder);
		
		
		//IDownloadTagWatermarking
		ProvidedInterface idownloadtagwatermarking = new ProvidedInterface(""tagwatermarking"", ""IDownloadTagWatermarking"");
		tagwatermarking.addProvidedInterface(idownloadtagwatermarking);
		
		//IUserDBAdapter
		ProvidedInterface iuserdbadapter = new ProvidedInterface(""userdbadapter"", ""IUserDBAdapter"");
		userdbadapter.addProvidedInterface(iuserdbadapter);
		
		//IUserManagement
		ProvidedInterface iusermanagement = new ProvidedInterface(""usermanagement"", ""IUserManagement"");
		usermanagement.addProvidedInterface(iusermanagement);
		
		
		
		//IDownload
		RequiredInterface RIdownload = new RequiredInterface(""IDownload"", idownloadmediaaccess);
		RequiredInterface RIusermanagement = new RequiredInterface(""IUserManagement"", iusermanagement);
		RequiredInterface RImediamanagement = new RequiredInterface(""IMediaManagement"", imediamanagement);
		RequiredInterface RImediaaccess = new RequiredInterface(""IMediaAccess"", imediaaccess);
		RequiredInterface RIpackaging = new RequiredInterface(""IPackaging"", ipackaging);
		RequiredInterface RIuserdbadapter = new RequiredInterface(""IUserDBAdapter"", iuserdbadapter);
		RequiredInterface RIfacade = new RequiredInterface(""IFacade"", ifacade);
		
		audiowatermarking.addRequiredInterface(RIdownload);
		
		cache.addRequiredInterface(RIdownload);
		
		facade.addRequiredInterface(RIusermanagement);
		facade.addRequiredInterface(RImediamanagement);

		
		mediamanagement.addRequiredInterface(RImediaaccess);
		mediamanagement.addRequiredInterface(RIpackaging);
		mediamanagement.addRequiredInterface(RIdownload);
		
		reencoder.addRequiredInterface(RIdownload);
		
		tagwatermarking.addRequiredInterface(RIdownload);
		
		usermanagement.addRequiredInterface(RIuserdbadapter);
		
		webbean.addRequiredInterface(RIfacade);
		
		ejbs.put(audiowatermarking.getName(), audiowatermarking);
		ejbs.put(cache.getName(), cache);
		ejbs.put(facade.getName(), facade);
		ejbs.put(mediaaccess.getName(), mediaaccess);
		ejbs.put(mediamanagement.getName(), mediamanagement);
		ejbs.put(packaging.getName(), packaging);
		ejbs.put(reencoder.getName(), reencoder);
		ejbs.put(tagwatermarking.getName(), tagwatermarking);
		ejbs.put(userdbadapter.getName(),userdbadapter);
		ejbs.put(usermanagement.getName(), usermanagement);
		ejbs.put(webbean.getName(), webbean);
		
		File xml = new File(""ejbconfig.xml"");
		xml.createNewFile();
		FileOutputStream fos = new FileOutputStream(xml);

		XStream xstream = new XStream();
		Class[] types = { EJB.class, ProvidedInterface.class,
				RequiredInterface.class };
		xstream.processAnnotations(types);
		xstream.useAttributeFor(EJB.class, ""name"");
		xstream.setMode(XStream.NO_REFERENCES);
		xstream.toXML(ejbs, fos);

		Config.loadConfig();
		ejbs.clear();
		ejbs = Config.getEJBs();
		for (String s : ejbs.keySet()) {
			System.out.println(ejbs.get(s));
			
		}
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/InterfaceDetails.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import edu.kit.ipd.sdq.mediastore.basic.interfaces.IBusinessInterface;

public class InterfaceDetails {
	private IBusinessInterface bi;
	private ProvidedInterface pi;
	private EJB ejb;
	private boolean local;
	public InterfaceDetails(IBusinessInterface bi, ProvidedInterface pi, EJB ejb, boolean local) {
		this.bi = bi;
		this.pi = pi;
		this.ejb = ejb;
		this.local = local;
	}
	
	public IBusinessInterface getBusinessInterface() {
		return bi;
	}
	
	public ProvidedInterface getProvidedInterface() {
		return pi;
	}
	
	public EJB getEJB() {
		return ejb;
	}
	
	public boolean isLocal() {
		return local;
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/ProvidedInterface.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import com.thoughtworks.xstream.annotations.XStreamAlias;

@XStreamAlias(""ProvidedInterface"")
public class ProvidedInterface {
	private String providingEJBName; //e.g mediaaccess
	private String name; //e.g. IDownloadMediaAccess
	public ProvidedInterface(String providingEJBName, String name) {
		this.providingEJBName = providingEJBName;
		this.name = name;
	}

	public String getFullName() {
		return ""edu.kit.ipd.sdq.mediastore.basic.interfaces."" + name;
	}


	public String getName() {
		return name;
	}

	
	public String getProvidingEJBName() {
		return providingEJBName;
	}
	
	public EJB getProvidingEJB() {
		return Config.getEJBs().get(providingEJBName);
	}
	
	@Override
	public String toString() {
		String result = """";
		result += ""\t Providing EJB : "" + providingEJBName + ""\n"";
		result += ""\t name : "" + name + ""\n"";
		return result;
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/GlobalConstantsContainer.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.config;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;

public class GlobalConstantsContainer {
    public static final String SEPARATOR = System.getProperty(""file.separator"");
    private static Properties properties = null;
    private static long timestamp = -1;
    
    
    public static String getTempDirPath() {
    	return getProperty(""TEMP_DIR_PATH"");
    }
    public static String getFileDir() {
        return getProperty(""FILE_DIR_PATH"");
    }
    public static int getCacheCapacity() {
    	return Integer.parseInt(getProperty(""CACHE_CAPACITY""));
    }
    
    private static String getProperty(String prop) {

        File configFile = new File(""GlobalConstantsContainer.properties"");
        System.out.println(configFile.lastModified());
    	if (properties == null || configFile.lastModified() != timestamp) {
    		loadProperties();
    	}
    	System.out.println(""Retrieving Property : "" + prop);
    	return properties.getProperty(prop);
    }
    private static void loadProperties() {
    	System.out.println(""Loading properties"");

        File configFile = new File(""GlobalConstantsContainer.properties"");
    	properties = new Properties();
		InputStream input = null;

		try {
			input = new FileInputStream(""GlobalConstantsContainer.properties"");
			properties.load(input);
			timestamp = configFile.lastModified();
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			if (input != null) {
				try {
					input.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}
    }
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/EJB.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import java.util.HashMap;
import java.util.Map;

import com.thoughtworks.xstream.annotations.XStreamAlias;

@XStreamAlias(""EJB"")
public class EJB {
	private String name;
	private String host;
	private String port;
	private String appName;
	private String moduleName;
	private String beanName;
	private Map<String, ProvidedInterface> providedInterfaces;
	private Map<String, RequiredInterface> requiredInterfaces;

	public EJB(String name, String host, String port, String appName, String moduleName, String beanName) {
		this.name = name;
		this.host = host;
		this.port = port;
		this.appName = appName;
		this.moduleName = moduleName;
		this.beanName = beanName;
		providedInterfaces = new HashMap<String, ProvidedInterface>();
		requiredInterfaces = new HashMap<String, RequiredInterface>();
	}

	public void setProvidedInterfaces(Map<String, ProvidedInterface> pi) {
		this.providedInterfaces = pi;
	}

	public void setRequiredInterfaces(Map<String, RequiredInterface> ri) {
		this.requiredInterfaces = ri;
	}

	public RequiredInterface getRequiredInterface(String interfaceName) {
		return requiredInterfaces.get(interfaceName);
	}

	public ProvidedInterface getProvidedInterface(String interfaceName) {
		return providedInterfaces.get(interfaceName);
	}

	public void addRequiredInterface(RequiredInterface ri) {
		requiredInterfaces.put(ri.getName(), ri);
	}
	
	public void addProvidedInterface(ProvidedInterface pi) {
		providedInterfaces.put(pi.getName(), pi);
	}
	
	public String getPort() {
		return port;
	}

	public String getHost() {
		return host;
	}

	public String getName() {
		return name;
	}
	
	public String getAppName() {
		return appName;
	}
	
	public String getModuleName() {
		return moduleName;
	}
	
	public String getBeanName() {
		return beanName;
	}

	@Override 
	public boolean equals(Object obj) {
		if (!(obj instanceof EJB))
			return false;
		
		if (obj == this)
			return true;
		
		EJB ejb = (EJB) obj;
		return (ejb.name.equals(name) &&
				ejb.host.equals(host) &&
				ejb.port.equals(port) &&
				ejb.appName.equals(appName) &&
				ejb.moduleName.equals(moduleName) &&
				ejb.beanName.equals(beanName));
	}
	
	@Override
	public String toString() {
		String result = ""\n"";
		result += ""EJB : "" + name + ""\n"";
		result += ""Host : "" + host + ""\n"";
		result += ""Port : "" + port + ""\n"";
		result += ""AppName : "" + appName + ""\n"";
		result += ""RequiredInterfaces : \n"";
		for (String s : requiredInterfaces.keySet()) {
			result += requiredInterfaces.get(s) + ""\n"";
		}
		result += ""ProvidedInterfaces : \n"";
		for (String s : providedInterfaces.keySet()) {
			result += providedInterfaces.get(s) + ""\n"";
		}
		result += ""\n"";
		return result;
	}

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/RequiredInterface.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import com.thoughtworks.xstream.annotations.XStreamAlias;

@XStreamAlias(""RequiredInterface"")
public class RequiredInterface {
	private String name; // e.g. IDownload
	private ProvidedInterface providedInterface; // e.g. IDownloadMediaAccess (name)

	
	public RequiredInterface(String name, ProvidedInterface providedInterface) {
		this.name = name;
		this.providedInterface = providedInterface;
	}
	
	public ProvidedInterface getProvidedInterface() {
		return providedInterface;
	}

	public String getName() {
		return name;
	}
	
	@Override
	public String toString() {
		String result = """";
		result += ""\t name : "" + name + ""\n"";
		result += ""\t Provided Interface :\n\n"" + providedInterface + ""\n"";
		return result;
	}

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/config/Config.java,"package edu.kit.ipd.sdq.mediastore.basic.config;

import java.io.File;
import java.util.Map;

import com.thoughtworks.xstream.XStream;

public class Config {
	private static Map<String, EJB> ejbs;
	private static long timestamp = -1;
	private static boolean reconfigurable = true;
	
	public static void loadConfig() {
		File config = new File(""C:\\ejbconfig.xml"");
		//System.out.println(""last timestamp : "" + timestamp );
		//System.out.println(""current timestamp : "" + config.lastModified());
		if (config.lastModified() == timestamp) {
			System.out.println(""config already up to date"");
			return;
		}
		//System.out.println(""loading config"");
		XStream xstream = new XStream();
		Class[] types = { EJB.class, ProvidedInterface.class,
				RequiredInterface.class };
		xstream.processAnnotations(types);

		xstream.useAttributeFor(EJB.class, ""name"");
		ejbs = (Map<String, EJB>) xstream.fromXML(config);
		timestamp = config.lastModified();
		//System.out.println(""Timestamp changed to "" + timestamp);
	}

	
	public static boolean isReconfigurable() {
		return reconfigurable;
	}
	public static Map<String, EJB> getEJBs() {
		return ejbs;
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/utils/FSUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.utils;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import edu.kit.ipd.sdq.mediastore.basic.config.GlobalConstantsContainer;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;

public class FSUtil {

    public static String getTempFileName(final String basePath, final String fileName, final String fileExtension) {
        return basePath + GlobalConstantsContainer.SEPARATOR + fileName.replace(""@"", """").replace(""."", """")
                + System.nanoTime() + '.' + fileExtension;
    }

    public static String getTempFileName(final String fileName, final String fileExtension) {
        return getTempFileName(GlobalConstantsContainer.getTempDirPath(), fileName, fileExtension);
    }

    
	public static void writeToFile(FileContent content, String inputPath) throws FileNotFoundException, IOException {
		if (content.isLocal()) {
			FileContentLocal localContent = (FileContentLocal) content;
			Files.copy(localContent.getPath(), Paths.get(inputPath));
		} 
		else {
			FileContentRemote remoteContent = (FileContentRemote) content;
			byte[] bytes = remoteContent.getBytes();
			writeToFile(bytes, inputPath);
			
		}
		
	}
    
    public static void writeToFile(final byte[] fileContent, final String filePath) throws FileNotFoundException,
            IOException {

        // create folders if necessary
        final File f = new File(filePath);
        f.getParentFile().mkdirs();

        // write to file
        final FileOutputStream fos = new FileOutputStream(filePath);
        fos.write(fileContent);
        fos.close();
    }

    public static String writeToTempFile(final FileContent fileContent, final String fileName, final String fileExtension)
            throws FileNotFoundException, IOException {
        final String tempFilePath = getTempFileName(fileName, fileExtension);
        writeToFile(fileContent, tempFilePath);
        return tempFilePath;
    }

    public static byte[] readFileToMem(final String filePath) throws FileNotFoundException, IOException {
        final File file = new File(filePath);
        final FileInputStream inputStream = new FileInputStream(file);
        final BufferedInputStream bufferedInput = new BufferedInputStream(inputStream);
        final byte[] bytes = new byte[inputStream.available()];
        bufferedInput.read(bytes);
        bufferedInput.close();
        inputStream.close();
        return bytes;
    }

    public static byte[] consumeFileToMem(final String filePath) throws FileNotFoundException, IOException {
        final byte[] bytes = readFileToMem(filePath);
        try {
            new File(filePath).delete();
        } catch (final Exception e) {
            System.out.println(""Deletion failed"");
            e.printStackTrace();
        }
        return bytes;
    }
    
    /**
     * Creates a temporary file based on its content and its full name
     * @param bytes Content of the file
     * @param fileName filename
     * @param extension file extension
     * @return path to the temporary file
     */
	public static Path bytesToPath(byte[] bytes, String fileName, String extension) {
		String filePath = FSUtil.getTempFileName(fileName, extension);
		try {
			FSUtil.writeToFile(bytes, filePath);
		} catch (IOException e) {
			e.printStackTrace();
		}
		return Paths.get(filePath);
	}
	
	/**
	 * Converts a file to a byte array
	 * @param filePath file path
	 * @return byte array 
	 */
	public static byte[] pathToBytes(Path filePath) {
		byte[] bytes = null;
		try {
			bytes = Files.readAllBytes(filePath);
		} catch (IOException e) {
			e.printStackTrace();
		}
		return bytes;
	}
	
	/**
	 * Determines whether the downloaded file is a mp3 or zip file based on the number of requested audio
	 * files to be downloaded
	 * @param requestedAudioCount number of audio files to be downloaded
	 * @return string containing the extension of the resulting mp3 or zip file
	 */
	public static String getExtension(int requestedAudioCount) {
		if (requestedAudioCount == 1)
			return ""mp3"";
		else
			return ""zip"";		
	}



}
 "
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/utils/LameUtil.java,"package edu.kit.ipd.sdq.mediastore.basic.utils;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.SystemUtils;

import edu.kit.ipd.sdq.mediastore.basic.exceptions.ConversionException;

public class LameUtil {

    /**
     * Copy lame.exe from the classpath to the working directory, if not already done
     *
     * @throws ConversionException
     *             if lame.exe cannot be accessed or copied
     */
    public static void initLame() throws ConversionException {
        System.out.println(""Initializing LAME"");
        final File lame = new File(""lame.exe"");
        if (!lame.exists() || lame.length() == 0) {
            // get the input stream to lame.exe (in the classpath directory)
            final InputStream is = new BufferedInputStream(LameUtil.class.getClassLoader().getResourceAsStream(
                    ""lame.exe""));
            if (is != null) {
                // create a file and a file output stream into which the data from the input stream
// should be written
                FileOutputStream fos = null;
                try {
                    // create lame.exe in the working directory
                    lame.createNewFile();
                    fos = new FileOutputStream(lame);
                    // write the contents of the input stream to the file (output stream)
                    int read = 0;
                    final byte[] bytes = new byte[8192];

                    while ((read = is.read(bytes)) != -1) {
                        fos.write(bytes, 0, read);
                    }
                    fos.flush();
                } catch (final IOException e) {
                    e.printStackTrace();
                    throw new ConversionException(""Failed to initialize lame"");
                } finally {
                    IOUtils.closeQuietly(is);
                    IOUtils.closeQuietly(fos);
                }
            }
        }
    }

    /**
     * encodes a file with a bitrate using LAME
     *
     * @param input
     *            input file path
     * @param output
     *            output file path
     * @param bitrate
     *            bitrate of destination file
     * @return true if conversion succeeded
     */
    public static boolean encode(final String input, final String output, final int bitrate) {
        System.out.println(""Encoding "" + new File(input).getAbsolutePath() + "" to ""
                + new File(output).getAbsolutePath());
        final String options = ""-h --cbr -b "" + bitrate + "" \"""" + input + ""\"" \"""" + output + ""\"""";
        execLame(options);
        return new File(output).exists() && new File(output).length() > 0;
    }

    /**
     * Decodes a file using LAME
     *
     * @param input
     *            input file path
     * @param output
     *            output file path
     * @return true if decoding succeeds
     */
    public static boolean decode(final String input, final String output) {
        System.out.println(""Decoding "" + new File(input).getAbsolutePath() + "" to ""
                + new File(output).getAbsolutePath());
        final String options = ""--decode \"""" + input + ""\"" \"""" + output + ""\"""";
        execLame(options);
        return new File(output).exists() && new File(output).length() > 0;
    }

    /**
     * Executes lame
     *
     * @param options
     *            to be passed to lame
     */
    public static void execLame(final String options) {
        Process p;
        try {
            // Launch lame encoder
            String lame = ""lame"";
            if (SystemUtils.IS_OS_WINDOWS) {
                lame += "".exe"";
            }
            p = Runtime.getRuntime().exec(lame + "" "" + options);
            final InputStreamReader pIsrErr = new InputStreamReader(p.getErrorStream());
            final InputStreamReader pIsrIn = new InputStreamReader(p.getInputStream());
            while (pIsrErr.read() != -1) {
            }
            while (pIsrIn.read() != -1) {
            }
            p.waitFor();
        } catch (final IOException e) {
            e.printStackTrace();
        } catch (final InterruptedException e) {
            e.printStackTrace();
        }
    }
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/utils/JNDIUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.utils;

import javax.naming.InitialContext;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.config.EJB;
import edu.kit.ipd.sdq.mediastore.basic.config.ProvidedInterface;

public class JNDIUtil {
    
    public static Object find(final ProvidedInterface pi, final boolean localCall) throws NamingException {
    	
        final InitialContext ctx1 = new InitialContext(PropertiesUtil.initProperties(pi));
        final EJB called = pi.getProvidingEJB();
        String JNDIName = """";
        if (localCall) {
        	JNDIName += ""java:app/"";
        }
        else {
        	JNDIName += ""java:global/"" + called.getAppName() + ""/"";
        }
        JNDIName += called.getModuleName() + ""/"";
        JNDIName += called.getBeanName();
   
        JNDIName += ""!"" + pi.getFullName();
        
        if (localCall) {
        	JNDIName += ""Local"";
        }
        else {
        	JNDIName += ""Remote"";
        }
        
        System.out.println(JNDIName + "" Port : "" + called.getPort());
        
        return ctx1.lookup(JNDIName);

    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/utils/PropertiesUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.utils;

import java.util.Properties;

import javax.naming.Context;

import edu.kit.ipd.sdq.mediastore.basic.config.EJB;
import edu.kit.ipd.sdq.mediastore.basic.config.ProvidedInterface;

public class PropertiesUtil {
    public static Properties initProperties(final ProvidedInterface  _interface) {

    	EJB providingEJB = _interface.getProvidingEJB();
        final String port = providingEJB.getPort();
        final String host = providingEJB.getHost();
        final String initContextFactory = ""com.sun.enterprise.naming.SerialInitContextFactory"";

        final Properties props = new Properties();
        props.put(Context.INITIAL_CONTEXT_FACTORY, initContextFactory);
        props.setProperty(""org.omg.CORBA.ORBInitialHost"", host);
        props.setProperty(""org.omg.CORBA.ORBInitialPort"", port);

        return props;
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/CurrentUser.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.data;

import java.io.Serializable;

/**
 * @author Anastasia @date: 07.12.2014
 */
public class CurrentUser implements Serializable {

    private static final long serialVersionUID = 1016233743738408827L;

    private Long id;
    private String firstname;
    private String lastname;
    private String email;
    private String passwordHash;

    public CurrentUser() {
    }

    public CurrentUser(final Long id, final String firstname, final String lastname, final String email,
            final String passwordHash) {
        super();
        this.id = id;
        this.firstname = firstname;
        this.lastname = lastname;
        this.email = email;
        this.passwordHash = passwordHash;
    }

    public Long getId() {
        return this.id;
    }

    public void setId(final Long id) {
        this.id = id;
    }

    public String getFirstname() {
        return this.firstname;
    }

    public void setFirstname(final String firstname) {
        this.firstname = firstname;
    }

    public String getLastname() {
        return this.lastname;
    }

    public void setLastname(final String lastname) {
        this.lastname = lastname;
    }

    public String getEmail() {
        return this.email;
    }

    public void setEmail(final String email) {
        this.email = email;
    }

    public String getPasswordHash() {
        return this.passwordHash;
    }

    public void setPasswordHash(final String passwordHash) {
        this.passwordHash = passwordHash;
    }

    @Override
    public String toString() {
        return ""CurrentUser [id="" + this.id + "", firstname="" + this.firstname + "", lastname="" + this.lastname
                + "", email="" + this.email + ""]"";
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/AudioFile.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.data;

import java.io.Serializable;

/**
 * Class represents an audio file including an input stream to access the data and a @see
 * {@link AudioFileInfo} object. The fields of the info object can be accessed directly through
 * getters and setters in this class.
 *
 * @author Emil Rakadjiev
 * @author Amine Kechaou
 */
public class AudioFile implements Serializable {

	private static final long serialVersionUID = 492084138637784340L;
	private AudioFileInfo info;
    private FileContent content;
    
    public AudioFile() {
        this.info = new AudioFileInfo();
    }

    public AudioFile(final AudioFileInfo info, final FileContent content) {
        super();
        this.info = info;
        this.content = content;
    }

    /**
     * @param info
     *            the audio file infos to set
     */
    public void setInfo(final AudioFileInfo info) {
        this.info = info;
    }

    /**
     * @return the audio file infos
     */
    public AudioFileInfo getInfo() {
        return this.info;
    }

    /**
     * @return the id in the DB
     */
    public Long getId() {
        return this.info.getId();
    }

    /**
     * @param id
     *            the id in the DB to set
     */
    public void setId(final Long id) {
        this.info.setId(id);
    }

    /**
     * @return the album
     */
    public String getAlbum() {
        return this.info.getAlbum();
    }

    /**
     * @param album
     *            the album to set
     */
    public void setAlbum(final String album) {
        this.info.setAlbum(album);
    }

    /**
     * @return the artist
     */
    public String getArtist() {
        return this.info.getArtist();
    }

    /**
     * @param artist
     *            the artist to set
     */
    public void setArtist(final String artist) {
        this.info.setArtist(artist);
    }

    /**
     * @return the bitrate
     */
    public Integer getBitrate() {
        return this.info.getBitrate();
    }

    /**
     * @param bitrate
     *            the bitrate to set
     */
    public void setBitrate(final Integer bitrate) {
        this.info.setBitrate(bitrate);
    }

    public String getFilename() {
        return this.info.getFilename();
    }

    /**
     * @return the genre
     */
    public String getGenre() {
        return this.info.getGenre();
    }

    /**
     * @param genre
     *            the genre to set
     */
    public void setGenre(final String genre) {
        this.info.setGenre(genre);
    }

    /**
     * @return the releaseyear
     */
    public Integer getReleaseyear() {
        return this.info.getReleaseyear();
    }

    /**
     * @param releaseyear
     *            the releaseyear to set
     */
    public void setReleaseyear(final Integer releaseyear) {
        this.info.setReleaseyear(releaseyear);
    }

    /**
     * @return the title
     */
    public String getTitle() {
        return this.info.getTitle();
    }

    /**
     * @param title
     *            the title to set
     */
    public void setTitle(final String title) {
        this.info.setTitle(title);
    }

    /**
     * @return the uploader
     */
    public Long getUploader() {
        return this.info.getUploader();
    }

    /**
     * @param uploader
     *            the uploader to set
     */
    public void setUploader(final Long uploader) {
        this.info.setUploader(uploader);
    }
    
    public void setContent(FileContent content) {
    	this.content = content;
    }
    
    public FileContent getContent() {
    	return content;
    }
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/UserRegData.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.data;

import java.io.Serializable;

public class UserRegData implements Serializable {

    private static final long serialVersionUID = 5539510381127707390L;

    private String firstname;
    private String lastname;
    private String email;
    private String password;

    public UserRegData(final String firstname, final String lastname, final String email, final String password) {
        super();
        this.firstname = firstname;
        this.lastname = lastname;
        this.email = email;
        this.password = password;
    }

    public String getFirstname() {
        return this.firstname;
    }

    public void setFirstname(final String firstname) {
        this.firstname = firstname;
    }

    public String getLastname() {
        return this.lastname;
    }

    public void setLastname(final String lastname) {
        this.lastname = lastname;
    }

    public String getEmail() {
        return this.email;
    }

    public void setEmail(final String email) {
        this.email = email;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(final String password) {
        this.password = password;
    }

    @Override
    public String toString() {
        return ""UserRegData [firstname="" + this.firstname + "", lastname="" + this.lastname + "", email="" + this.email
                + "", password="" + this.password + ""]"";
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/FileContent.java,"package edu.kit.ipd.sdq.mediastore.basic.data;

import java.io.IOException;
import java.io.Serializable;
import java.nio.file.Files;
import java.nio.file.Path;

import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

public abstract class FileContent implements Serializable {
	/**
	 * 
	 */
	private static final long serialVersionUID = -6365409533974513480L;

	public abstract boolean isLocal();
	
	
	/**
	 * Converts a FileContentLocal to a FileContentRemote or vice versa when needed
	 * @param local true if the desired FileContent is local, false otherwise
	 * @param fileName Name of the temporary file to be created if the current FileContent is remote
	 * and the desired FileContent is local 
	 * @param extension Extension of the local file
	 * @return A new FileContentRemote/Local or this object if no conversion needed, that is when 
	 * this object is a FileContentRemote (resp. Local) and local=false (resp. true)
	 */
	public FileContent convertIfNeeded(boolean local, String fileName, String extension) {
		FileContent content = this;
        if (isLocal() && !local) { 
    		FileContentLocal localContent = (FileContentLocal) this;
    		byte[] data = FSUtil.pathToBytes(localContent.getPath());
    		content = new FileContentRemote(data);
    		try {
				Files.deleteIfExists(localContent.getPath());
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
        }
        else if (!isLocal() && local) {
    		FileContentRemote remoteContent = (FileContentRemote) content;
        	Path filePath = FSUtil.bytesToPath(remoteContent.getBytes(), fileName, extension);
    		content = new FileContentLocal(filePath);
        }
        return content;
	}
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/FileContentLocal.java,"package edu.kit.ipd.sdq.mediastore.basic.data;

import java.nio.file.Path;

public class FileContentLocal extends FileContent {
	/**
	 * 
	 */
	private static final long serialVersionUID = -2227858509812298329L;
	private Path path;
	
	
	
	public FileContentLocal(Path path) {
		super();
		this.path = path;
	}



	public Path getPath() {
		return path;
	}



	public void setPath(Path path) {
		this.path = path;
	}



	@Override
	public boolean isLocal() {
		return true;
	}
	
}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/AudioFileInfo.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.basic.data;

import java.io.Serializable;

/**
 * Class containing the information for a given song. It is used to transfer information between the
 * client and the DB. It is almost identical to the Audio entity. The entity was not used, in order
 * to reduce dependencies on it (entites are used only in the DB classes).
 *
 * @author Emil Rakadjiev
 */
public class AudioFileInfo implements Serializable {

    private static final long serialVersionUID = -6170216542852727972L;

    private Long id;
    private String album;
    private String artist;
    private Integer bitrate;
    private String genre;
    private Integer releaseyear;
    private String title;
    private Long uploader;

    public AudioFileInfo() {
    }

    public AudioFileInfo(final Long id, final String album, final String artist, final Integer bitrate,
            final String genre, final Integer releaseyear, final String title, final Long uploader) {
        super();
        this.id = id;
        this.album = album;
        this.artist = artist;
        this.bitrate = bitrate;
        this.genre = genre;
        this.releaseyear = releaseyear;
        this.title = title;
        this.uploader = uploader;
    }

    /**
     * @return the id in the DB
     */
    public Long getId() {
        return this.id;
    }

    /**
     * @param id
     *            the id in the DB to set
     */
    public void setId(final Long id) {
        this.id = id;
    }

    /**
     * @return the album
     */
    public String getAlbum() {
        return this.album;
    }

    /**
     * @param album
     *            the album to set
     */
    public void setAlbum(final String album) {
        this.album = album;
    }

    /**
     * @return the artist
     */
    public String getArtist() {
        return this.artist;
    }

    /**
     * @param artist
     *            the artist to set
     */
    public void setArtist(final String artist) {
        this.artist = artist;
    }

    /**
     * @return the bitrate
     */
    public Integer getBitrate() {
        return this.bitrate;
    }

    /**
     * @param bitrate
     *            the bitrate to set
     */
    public void setBitrate(final Integer bitrate) {
        this.bitrate = bitrate;
    }

    public String getFilename() {
        final StringBuilder sb = new StringBuilder();
        sb.append(this.artist);
        sb.append("" - "");
        sb.append(this.title);
        sb.append("".mp3"");
        final String filename = sb.toString().replace("" "", ""_"");
        return filename;
    }

    /**
     * @return the genre
     */
    public String getGenre() {
        return this.genre;
    }

    /**
     * @param genre
     *            the genre to set
     */
    public void setGenre(final String genre) {
        this.genre = genre;
    }

    /**
     * @return the releaseyear
     */
    public Integer getReleaseyear() {
        return this.releaseyear;
    }

    /**
     * @param releaseyear
     *            the releaseyear to set
     */
    public void setReleaseyear(final Integer releaseyear) {
        this.releaseyear = releaseyear;
    }

    /**
     * @return the title
     */
    public String getTitle() {
        return this.title;
    }

    /**
     * @param title
     *            the title to set
     */
    public void setTitle(final String title) {
        this.title = title;
    }

    /**
     * @return the uploader
     */
    public Long getUploader() {
        return this.uploader;
    }

    /**
     * @param uploader
     *            the uploader to set
     */
    public void setUploader(final Long uploader) {
        this.uploader = uploader;
    }

    @Override
    public String toString() {
        return ""AudioFileInfo [album="" + this.album + "", artist="" + this.artist + "", bitrate="" + this.bitrate
                + "", genre="" + this.genre + "", releaseyear="" + this.releaseyear + "", title="" + this.title
                + "", uploader="" + this.uploader + ""]"";
    }

}"
Implementation/mediastore.basic/src/edu/kit/ipd/sdq/mediastore/basic/data/FileContentRemote.java,"package edu.kit.ipd.sdq.mediastore.basic.data;

public class FileContentRemote extends FileContent {
	/**
	 * 
	 */
	private static final long serialVersionUID = 2989985117433061244L;
	private byte[] bytes;
	
	public FileContentRemote(byte[] bytes) {
		super();
		this.bytes = bytes;
	}
	
	public byte[] getBytes() {
		return bytes;
	}

	public void setBytes(byte[] bytes) {
		this.bytes = bytes;
	}

	@Override
	public boolean isLocal() {
		return false;
	}
	
}"
Implementation/mediastore.ejb.tagwatermarking/src/edu/kit/ipd/sdq/mediastore/ejb/tagwatermarking/TagWatermarkingImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.tagwatermarking;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.ejb.Stateless;
import javax.naming.NamingException;

import org.jaudiotagger.audio.AudioFileIO;
import org.jaudiotagger.audio.exceptions.CannotReadException;
import org.jaudiotagger.audio.exceptions.CannotWriteException;
import org.jaudiotagger.audio.exceptions.InvalidAudioFrameException;
import org.jaudiotagger.audio.exceptions.ReadOnlyFileException;
import org.jaudiotagger.audio.mp3.MP3File;
import org.jaudiotagger.tag.FieldKey;
import org.jaudiotagger.tag.Tag;
import org.jaudiotagger.tag.TagException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownload;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadTagWatermarkingLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadTagWatermarkingRemote;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

/**
 * Session Bean implementation class TagwatermarkingImpl
 */
@Stateless
public class TagWatermarkingImpl extends BaseEJB implements IDownloadTagWatermarkingRemote, IDownloadTagWatermarkingLocal {

    /**
	 * 
	 */
	private static final long serialVersionUID = 7711132340993624916L;
	private IDownload next;

    /**
     * Default constructor.
     */
    public TagWatermarkingImpl() {
    	super();
    	ejbName = ""tagwatermarking"";
    }

    @PostConstruct
    public void init() {
        this.next = initRequiredInterface(""IDownload"", IDownload.class);
    }

    @Override
    public List<AudioFile> download(final List<Long> requestedAudioIDs, final List<Integer> bitrates,
            final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

        final List<AudioFile> fileList = this.next.download(requestedAudioIDs, bitrates, downloaderLogin, isLocal(""IDownload""));

        for (AudioFile audioFile : fileList) {
        	try {
				this.watermark(audioFile, downloaderLogin, localCall);
			} catch (IOException e) {
				throw new FailedDownloadException(audioFile.getFilename());
			} 
        }

        return fileList;
    }

    private void watermark(AudioFile audioFile, String downloaderLogin, boolean localCall) throws FileNotFoundException, IOException {
        final String tempFileName = FSUtil.writeToTempFile(audioFile.getContent(), downloaderLogin + audioFile.getFilename(), ""mp3"");
        
            MP3File mp3file;
			try {
				mp3file = (MP3File) AudioFileIO.read(new File(tempFileName));
	            final Tag tag = mp3file.getTagOrCreateAndSetDefault();
	            tag.setField(FieldKey.COMMENT, downloaderLogin + "" has downloaded this file from Mediastore"");
	            mp3file.commit();
	            if (!localCall) {
	                final byte[] bytes = FSUtil.consumeFileToMem(tempFileName);
	                audioFile.setContent(new FileContentRemote(bytes));
	            }
	            else {
	            	audioFile.setContent(new FileContentLocal(Paths.get(tempFileName)));
	            }
			} catch (CannotReadException | IOException | TagException
					| ReadOnlyFileException | InvalidAudioFrameException | CannotWriteException e) {
				e.printStackTrace();
			}

    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/SessionBean.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.beans;

import java.io.Serializable;

import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;

/**
 * @author Anastasia
 * @date 28.11.2014
 */
@ManagedBean(name = ""sessionBean"")
@SessionScoped
public class SessionBean implements Serializable {

    private static final long serialVersionUID = 3127338997048577039L;

    public Boolean isLoggedIn = false;
    private CurrentUser currentUser = null;

    public SessionBean() throws NamingException {

    }

    public CurrentUser getCurrentUser() {
        return this.currentUser;
    }

    public void setCurrentUser(final CurrentUser currentUser) {
        this.currentUser = currentUser;
    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/RegisterBean.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.beans;

import java.io.Serializable;

import javax.faces.bean.ManagedBean;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.UserRegData;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.UserAlreadyExistsException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacade;
import edu.kit.ipd.sdq.mediastore.web.utils.MessageUtil;

/**
 * @author Anastasia
 */
@ManagedBean
public class RegisterBean implements Serializable {

    private static final long serialVersionUID = -5229414856228963671L;

    private String email;
    private String firstName;
    private String lastName;
    private String password;

    
    public String getEmail() {
        return this.email;
    }

    public void setEmail(final String email) {
        this.email = email;
    }

    public String getFirstName() {
        return this.firstName;
    }

    public void setFirstName(final String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return this.lastName;
    }

    public void setLastName(final String lastName) {
        this.lastName = lastName;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(final String password) {
        this.password = password;
    }

    public String doRegister() {
        System.out.println(""RegisterBean.doRegister()"");
//        System.err.println(String.format(""RegisterBean.doRegister: plain=%s"", this.getPassword() ));
        final Long start = System.currentTimeMillis();
        final UserRegData regData = new UserRegData(this.getFirstName(), this.getLastName(), this.getEmail(),
                this.getPassword());
        try {
            final Long saveNewUser = WebBeanManager.initRequiredInterface(""IFacade"", IFacade.class).register(regData);
            System.out.println(saveNewUser);
            System.out.println(""Time for registration(in ms): "" + (System.currentTimeMillis() - start));
            return ""login"";

        } catch (final NamingException e) {
            MessageUtil.showError(""Server ERROR"");
            e.printStackTrace();
        } catch (final UserAlreadyExistsException e) {
            MessageUtil.showError(e.getMessage());
        }
        return ""register"";
    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/UploadBean.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.beans;

import java.io.IOException;
import java.io.Serializable;
import java.nio.file.Files;
import java.nio.file.Path;
import java.rmi.RemoteException;

import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.naming.NamingException;

import org.primefaces.model.UploadedFile;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacade;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;
import edu.kit.ipd.sdq.mediastore.web.utils.MessageUtil;

@ManagedBean(name = ""uploadBean"")
@ViewScoped
public class UploadBean implements Serializable {

    private static final long serialVersionUID = 14224877237481385L;

    @ManagedProperty(value = ""#{sessionBean}"")
    private SessionBean sessionBean;

    @ManagedProperty(value = ""#{downloadBean}"")
    private DownloadBean downloadBean;

    private String album;
    private String artist;
    private int bitrate;
    private String genre;
    private int releaseyear;
    private String title;
    private Long uploader;
    

    private IFacade facade;

    private UploadedFile file;

    private void initFacade() {
    	facade = WebBeanManager.initRequiredInterface(""IFacade"", IFacade.class);
    }
    
    public UploadedFile getFile() {
        return this.file;
    }

    public void setFile(final UploadedFile file) {
        this.file = file;
    }

    public void upload() {
        final Long start = System.currentTimeMillis();
        final byte[] contents = this.file.getContents();

        this.setUploader(this.sessionBean.getCurrentUser().getId());
        final AudioFileInfo audioFileInfo = new AudioFileInfo(null, this.getAlbum(), this.getArtist(),
                this.getBitrate(), this.getGenre(), this.getReleaseyear(), this.getTitle(), this.getUploader());

        Long id = null;

        try {
        	initFacade();
        	AudioFile audioFile = new AudioFile();
        	Path filePath = null;
        	if (!WebBeanManager.isLocal(""IFacade"")) {
                audioFile.setContent(new FileContentRemote(contents));
        	} else {
        		String fileName = this.sessionBean.getCurrentUser().getEmail() + ""Upload-Facade"";
        		filePath = FSUtil.bytesToPath(contents, fileName, ""mp3"");
        		audioFile.setContent(new FileContentLocal(filePath));
        	}
        	
            audioFile.setInfo(audioFileInfo);
            id = facade.upload(audioFile);
            if (filePath != null) {
                try {
    				Files.deleteIfExists(filePath);
    			} catch (IOException e) {
    				e.printStackTrace();
    			}
            }
            System.out.println(""Time for upload(in ms):"" + (System.currentTimeMillis() - start));

            audioFileInfo.setId(id);
            MessageUtil.showSuccess(""User: "" + this.sessionBean.getCurrentUser().getFirstname() + "" ""
                    + this.sessionBean.getCurrentUser().getLastname() + "" hat "" + this.toString() + "" uploaded."");
            this.downloadBean.addAudioToList(audioFileInfo);

        } catch (final NamingException e) {
            MessageUtil.showError(""NamingException"");
            e.printStackTrace();
        } catch (final FailedUploadException e) {
            MessageUtil.showError(""FailedUploadException: "" + e.getMessage());
            e.printStackTrace();
        } catch (final RemoteException e) {
            MessageUtil.showError(""RemoteException"");
            e.printStackTrace();
        }

        System.out.println(""Upload dauerte: "" + (System.currentTimeMillis() - start) + "" ms"");
    }

    public String getAlbum() {
        return this.album;
    }

    public void setAlbum(final String album) {
        this.album = album;
    }

    public String getArtist() {
        return this.artist;
    }

    public void setArtist(final String artist) {
        this.artist = artist;
    }

    public int getBitrate() {
        return this.bitrate;
    }

    public void setBitrate(final int bitrate) {
        this.bitrate = bitrate;
    }

    public String getGenre() {
        return this.genre;
    }

    public void setGenre(final String genre) {
        this.genre = genre;
    }

    public int getReleaseyear() {
        return this.releaseyear;
    }

    public void setReleaseyear(final int releaseyear) {
        this.releaseyear = releaseyear;
    }

    public String getTitle() {
        return this.title;
    }

    public void setTitle(final String title) {
        this.title = title;
    }

    public Long getUploader() {
        return this.uploader;
    }

    public void setUploader(final Long uploader) {
        this.uploader = uploader;
    }

    public SessionBean getSessionBean() {
        return this.sessionBean;
    }

    public void setSessionBean(final SessionBean sessionBean) {
        this.sessionBean = sessionBean;
    }

    public DownloadBean getDownloadBean() {
        return this.downloadBean;
    }

    public void setDownloadBean(final DownloadBean downloadBean) {
        this.downloadBean = downloadBean;
    }

    @Override
    public String toString() {
        return ""Audio  "" + this.file.getFileName() + ""  mit dem Title="" + this.title;
    }
}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/WebBeanManager.java,"package edu.kit.ipd.sdq.mediastore.web.beans;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IBusinessInterface;
public class WebBeanManager {
	private static WebBean webBean = new WebBean();

	public static <T extends IBusinessInterface> T initRequiredInterface(String requiredInterface, Class<T> type) {
		return webBean.initRequiredInterface(requiredInterface, type);
	}
	
	public static boolean isLocal(String interfaceName) {
		return webBean.isLocal(interfaceName);
	}
	
	private static class WebBean extends BaseEJB {
		public WebBean() {
			super();
			ejbName = ""webbean"";
		}
		
		protected <T extends IBusinessInterface> T initRequiredInterface(String requiredInterface, Class<T> type) {
			return super.initRequiredInterface(requiredInterface, type);
		}
		
		protected boolean isLocal(String interfaceName) {
			return loadedInterfaces.get(interfaceName).isLocal();
		}

	}
	
}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/LoginBean.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.beans;

import java.io.Serializable;

import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.data.CurrentUser;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.BadLoginDataException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacade;
import edu.kit.ipd.sdq.mediastore.web.utils.MessageUtil;

/**
 *
 * @author Anastasia
 *
 */
@ManagedBean(name = ""loginBean"")
@ViewScoped
public class LoginBean implements Serializable {

    private static final long serialVersionUID = 6536288910967304447L;

    @ManagedProperty(value = ""#{sessionBean}"")
    private SessionBean sessionBean;

    private String username;
    private String password;

    public String dologin() {

        try {
//            System.err.println(String.format(""LoginBean.dologin: plain=%s"", this.getPassword() ));
            CurrentUser registeredUser = WebBeanManager.initRequiredInterface(""IFacade"", IFacade.class).login(this.getUsername(), this.getPassword());
            this.sessionBean.setCurrentUser(registeredUser);
            this.sessionBean.isLoggedIn = true;

            return ""index"";

        } catch (final NamingException e) {
            MessageUtil.showError(""Server cannot be found"");
            e.printStackTrace();
        } catch (final BadLoginDataException e) {
            MessageUtil.showError(e.getMessage());
            e.printStackTrace();
        }

        return ""login"";
    }

    public SessionBean getSessionBean() {
        return this.sessionBean;
    }

    public void setSessionBean(final SessionBean sessionBean) {
        this.sessionBean = sessionBean;
    }

    public String getUsername() {
        return this.username;
    }

    public void setUsername(final String username) {
        this.username = username;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(final String password) {
        this.password = password;
    }
}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/beans/DownloadBean.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.beans;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Serializable;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import javax.annotation.PostConstruct;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.faces.event.AjaxBehaviorEvent;
import javax.naming.NamingException;

import org.primefaces.model.DefaultStreamedContent;
import org.primefaces.model.StreamedContent;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IFacade;
import edu.kit.ipd.sdq.mediastore.web.utils.MessageUtil;

/**
 * @author Anastasia
 */
@ManagedBean(name = ""downloadBean"")
@ViewScoped
public class DownloadBean implements Serializable {
	
    private static final long serialVersionUID = -5118787891821223770L;

    @ManagedProperty(value = ""#{sessionBean}"")
    private SessionBean sessionBean;

    private List<AudioFileInfo> audios;
    private Map<AudioFileInfo, Boolean> checked = new HashMap<AudioFileInfo, Boolean>();
    private List<Long> audiosToDownload = new ArrayList<Long>();
    private final List<Integer> bitrates = new ArrayList<Integer>();
    private StreamedContent file;
    
    private IFacade facade;
    
    @PostConstruct
    void init() {

        try {
        	initFacade();
            this.audios = facade.getFileList();
        } catch (final NamingException e) {
            e.printStackTrace();
            MessageUtil.showError(""Server wurde nicht gefunden."");
        }

    }
    
    private void initFacade() {
    	facade = WebBeanManager.initRequiredInterface(""IFacade"", IFacade.class);
    }

    public void download() {

        final StringBuilder nameForDownload = new StringBuilder();
        for (final Entry<AudioFileInfo, Boolean> item : this.checked.entrySet()) {
            if (item.getValue()) {
                final AudioFileInfo infoTemp = item.getKey();
                this.audiosToDownload.add(infoTemp.getId());
                nameForDownload.append(""["").append(infoTemp.getTitle()).append(""]""); // build name
// for download
                final Integer bitrate = infoTemp.getBitrate();
                if (bitrate != 128 && bitrate != 192 && bitrate != 256 && bitrate != 320) { // TODO:
// this is a hack, should be fixed in index.xhtml
                    MessageUtil.showError(""Es muss fuer jeden Download eine Bitrate ausgewhlt werden."");
                    return;
                }
                this.bitrates.add(bitrate);
            }
        }
        if (this.audiosToDownload != null) {
            final int downloadCount = this.audiosToDownload.size();
            if (downloadCount != 0) {
                try {
                    String contentType;
                    String fileName;
                    if (downloadCount == 1) {
                        contentType = ""audio/mpeg"";
                        nameForDownload.append("".mp3"");
                        
                    } else {
                        contentType = ""application/zip"";
                        nameForDownload.append("".zip"");
                    }
                    fileName = nameForDownload.toString();
                	String login = this.sessionBean.getCurrentUser().getEmail();
                	initFacade();
                	InputStream is = null;
                	Path filePath = null;
                	FileContent content = facade.download(this.audiosToDownload, this.bitrates, login, WebBeanManager.isLocal(""IFacade""));
                	if (!content.isLocal()) {
                        final byte[] data = ((FileContentRemote) content).getBytes();
                        is = new ByteArrayInputStream(data);
                	}
                	else {
                		filePath = ((FileContentLocal) content).getPath();
                		is = Files.newInputStream(filePath);
                	}
                    this.file = new DefaultStreamedContent(is, contentType, fileName);
                    
                	if (filePath != null) {
                		Files.deleteIfExists(filePath);
                	}
                } catch (final FailedDownloadException e) {
                    MessageUtil.showError(e.getMessage());
                } catch (final NamingException e) {
                    MessageUtil.showError(""Server wurde nicht gefunden."");
                } catch (IOException e) {
                    MessageUtil.showError(e.getMessage());
					e.printStackTrace();
				}
            }
        }

        // After Download clear all variables
        this.audiosToDownload.clear();
        this.bitrates.clear();
        nameForDownload.setLength(0);
    }

    public void check(final AjaxBehaviorEvent event) {
    }

    public SessionBean getSessionBean() {
        return this.sessionBean;
    }

    public void setSessionBean(final SessionBean sessionBean) {
        this.sessionBean = sessionBean;
    }

    public List<AudioFileInfo> getAudios() {
        return this.audios;
    }

    public void setAudios(final List<AudioFileInfo> audios) {
        this.audios = audios;
    }


    public List<Long> getAudiosToDownload() {
        return this.audiosToDownload;
    }

    public void setAudiosToDownload(final List<Long> audiosToDownload) {
        this.audiosToDownload = audiosToDownload;
    }

    public Map<AudioFileInfo, Boolean> getChecked() {
        return this.checked;
    }

    public void setChecked(final Map<AudioFileInfo, Boolean> checked) {
        this.checked = checked;
    }

    public StreamedContent getFile() {
        return this.file;
    }

    public void setFile(final StreamedContent file) {
        this.file = file;
    }

    public void addAudioToList(final AudioFileInfo audioInfo) {
        this.audios.add(audioInfo);
    }

    public static String generateId(final String value, final Long index) {
        return value + ""_"" + index;
    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/filters/MainFilter.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.filters;

import java.io.IOException;
import java.util.logging.Logger;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import edu.kit.ipd.sdq.mediastore.web.beans.SessionBean;

/**
 * @author Anastasia @date: 09.12.2014
 */
public class MainFilter implements Filter {

    private static final String INDEX_URL = ""index.xhtml"";
    private static final String REGISTER_URL = ""register"";
    private static final String LOGOUT_URL = ""logout"";
    private static final String LOGIN_URL = ""login.xhtml"";

    private static final String SESSION_BEAN = ""sessionBean"";

    Logger logger = Logger.getLogger(this.getClass().getName());

    @Override
    public void destroy() {

    }

    /**
     * Check: if user logged --> redirect to main page if user not logged --> redirect to login page
     */
    @Override
    public void doFilter(final ServletRequest req, final ServletResponse res, final FilterChain chain)
            throws IOException, ServletException {

        final HttpServletRequest request = (HttpServletRequest) req;
        final HttpServletResponse response = (HttpServletResponse) res;
        final SessionBean session = (SessionBean) request.getSession().getAttribute(SESSION_BEAN);
        final String url = request.getRequestURI();
        this.logger.info(""URL: "" + url);

        if (url.endsWith("".js.xhtml"") || url.endsWith("".css.xhtml"") || url.endsWith("".png.xhtml"")) {
            chain.doFilter(req, res);
            return;
        }

        if (session == null || !session.isLoggedIn) {
            if (url.indexOf(LOGIN_URL) < 0 && url.indexOf(REGISTER_URL) < 0) {
                this.logger.info(""Redirect to login page"");
                response.sendRedirect(LOGIN_URL);
            } else {
                chain.doFilter(req, res);
            }
        } else {
            if (url.indexOf(LOGIN_URL) >= 0 || url.indexOf(REGISTER_URL) >= 0) {
                this.logger.info(""Redirect to main page"");
                response.sendRedirect(INDEX_URL);
            } else if (url.indexOf(LOGOUT_URL) >= 0) {
                request.getSession().removeAttribute(SESSION_BEAN);
                this.logger.info(""Redirect to login page"");
                response.sendRedirect(LOGIN_URL);
            } else {
                chain.doFilter(req, res);
            }
        }
    }

    @Override
    public void init(final FilterConfig arg0) throws ServletException {

    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/utils/SessionUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.utils;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

/**
 * @author Anastasia @date: 07.12.2014
 */
public class SessionUtil {

    private static final String CURRENT_USER = ""currentUser"";

    public static Boolean isLoggedIn(final HttpServletRequest req) {

        final HttpSession session = req.getSession(false);

        if (session != null) {
            if (session.getAttribute(CURRENT_USER) != null) {
                return true;
            }
        }

        return false;
    }

}"
Implementation/mediastore.web/src/edu/kit/ipd/sdq/mediastore/web/utils/MessageUtil.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.web.utils;

import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;

public class MessageUtil {

    public static void showError(final String message) {
        final FacesMessage facesMessage = new FacesMessage(FacesMessage.SEVERITY_ERROR, message, """");
        FacesContext.getCurrentInstance().addMessage(null, facesMessage);
    }

    public static void showInfo(final String message) {
        final FacesMessage facesMessage = new FacesMessage(FacesMessage.SEVERITY_INFO, message, """");
        FacesContext.getCurrentInstance().addMessage(null, facesMessage);
    }

    public static void showSuccess(final String message) {
        final FacesMessage facesMessage = new FacesMessage(""Succesful"", message);
        FacesContext.getCurrentInstance().addMessage(null, facesMessage);
    }
}"
Implementation/mediastore.ejb.reencoder/src/edu/kit/ipd/sdq/mediastore/ejb/reencoder/ReEncoderImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.reencoder;

import java.io.File;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.ejb.Stateless;
import javax.naming.NamingException;

import org.apache.commons.lang3.SystemUtils;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.ConversionException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownload;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadReEncoderLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadReEncoderRemote;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;
import edu.kit.ipd.sdq.mediastore.basic.utils.LameUtil;

/**
 * Session Bean implementation class Reencoding
 */

@Stateless
public class ReEncoderImpl extends BaseEJB implements IDownloadReEncoderRemote, IDownloadReEncoderLocal {

    /**
	 * 
	 */
	private static final long serialVersionUID = -7949934777121714398L;
	private IDownload next;

    /**
     * Default constructor.
     */
    public ReEncoderImpl() {
    	super();
    	ejbName = ""reencoder"";
    }

    @PostConstruct
    public void init() {
    	this.next = initRequiredInterface(""IDownload"", IDownload.class);
    }

    /**
     * Encode an mp3 file to a given bitrate using lame encoder. Note that lame is used here as an
     * .exe file, i.e. the implementation works only under Windows.
     * 
     * @param audioFile
     *            The audioFile object which references the file to be encoded
     * @param bitrate
     *            Target bitrate
     * @param timeStamp
     * @throws MediaStoreException
     *             Thrown if lame cannot be initialized, if an error happens during encoding or if
     *             there is any IO exception
     */
    @Override
    public List<AudioFile> download(final List<Long> requestedAudioIDs, final List<Integer> bitrates,
            final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

        // get files from next EJB
        final List<AudioFile> audios = this.next.download(requestedAudioIDs, bitrates, downloaderLogin, isLocal(""IDownload""));

        // copy lame encoder from the classpath to the working directory
        if (SystemUtils.IS_OS_WINDOWS) {
            try {
                LameUtil.initLame();
            } catch (final ConversionException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        int i = 0;
        for (final AudioFile audio : audios) {
            final int bitrate = bitrates.get(i);

            // file path of the file which should be encoded
            String inputFilePath;
            FileContent content = audio.getContent();
            try {
                inputFilePath = FSUtil.writeToTempFile(content, downloaderLogin, ""mp3"");
            } catch (final IOException e) {
                // TODO propper exc handling
                throw new RuntimeException(""Could not create temp file"", e);
            }

            // file name (including directory name) of the encoded file
            final String outputFilePath = FSUtil.getTempFileName(downloaderLogin, ""mp3"");

            // reencode
            LameUtil.encode(inputFilePath, outputFilePath, bitrate);

            // delete temporary input file
            new File(inputFilePath).delete();

            if (!localCall) {
                // read output to memory and save in return set
                byte[] bytes;
                try {
                    bytes = FSUtil.consumeFileToMem(outputFilePath);
                } catch (final IOException e) {
                    // TODO propper exc handling
                    throw new RuntimeException(""Could not read file to memory"", e);
                }
                audio.setContent(new FileContentRemote(bytes));
            }
            else {
            	audio.setContent(new FileContentLocal(Paths.get(outputFilePath)));
            }

        }

        return audios;
    }
}"
Implementation/mediastore.ejb.cache/ejbModule/edu/kit/ipd/sdq/mediastore/ejb/cache/CacheSingleton.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.cache;

import javax.annotation.PostConstruct;
import javax.ejb.LocalBean;
import javax.ejb.Singleton;
import javax.ejb.TransactionManagement;
import javax.ejb.TransactionManagementType;

import com.google.common.cache.Cache;
import com.google.common.cache.CacheBuilder;

import edu.kit.ipd.sdq.mediastore.basic.config.GlobalConstantsContainer;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;

/**
 * Session Bean implementation class CacheSingleton
 */
@Singleton
@TransactionManagement(TransactionManagementType.BEAN)
@LocalBean
public class CacheSingleton {

    private Cache<IdAndBitrate, AudioFile> cache;

    private int hits = 0;
    private int misses = 0;

    synchronized void incHits() {
        this.hits++;
    }

    synchronized void incMisses() {
        this.misses++;
    }

    synchronized double getHitrate() {
        return ((double) this.hits) / (this.hits + this.misses);
    }

    @PostConstruct
    public void init() {
        System.out.println(""init cache"");
        this.cache = CacheBuilder.newBuilder().maximumSize(GlobalConstantsContainer.getCacheCapacity()).build();
    }

    public AudioFile getIfPresent(final IdAndBitrate request) {
        final AudioFile cachedAudio = this.cache.getIfPresent(request);
        if (cachedAudio == null) {
            this.incMisses();
//			System.out.println(""cache miss for ("" + id + "","" + bitrate + ')');
        } else {
            this.incHits();
            System.out.println(""cache hit for ("" + request.getId() + "","" + request.getBitrate()
                    + "") Current hitrate is "" + this.getHitrate());
        }
        return cachedAudio;
    }

    public void put(final IdAndBitrate idAndBitrate, final AudioFile unCachedAudio) {
        this.cache.put(idAndBitrate, unCachedAudio);
//		System.out.println(""store in cache: ("" + id + "","" + bitrate + ')');
    }

    public void clear() {
        System.out.println(""clearing cache"");
        this.cache.invalidateAll();
        this.cache.cleanUp();
    }
}"
Implementation/mediastore.ejb.cache/ejbModule/edu/kit/ipd/sdq/mediastore/ejb/cache/IdAndBitrate.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.cache;

import java.io.Serializable;

public class IdAndBitrate implements Serializable {

    private static final long serialVersionUID = -8701255441272247362L;

    private long id;
    private int bitrate;

    public IdAndBitrate(final long id, final int bitrate) {
        this.id = id;
        this.bitrate = bitrate;
    }

    public long getId() {
        return this.id;
    }

    public void setId(final int id) {
        this.id = id;
    }

    public int getBitrate() {
        return this.bitrate;
    }

    public void setBitrate(final int bitrate) {
        this.bitrate = bitrate;
    }

    @Override
    public int hashCode() {
//		System.out.println(""get hash"");
        return (this.id + "","" + this.bitrate).hashCode();
    }

    @Override
    public boolean equals(final Object obj) {
//		System.out.println(""equals"");
        if (!(obj instanceof IdAndBitrate)) {
            return false;
        }
        final IdAndBitrate other = (IdAndBitrate) obj;
//		System.out.println(""Comparing ids "" + this.id + "" & "" + other.id + "" and bitrates "" + this.bitrate + "" & "" + other.bitrate);
        return (this.id == other.id) && (this.bitrate == other.bitrate);
    }
}"
Implementation/mediastore.ejb.cache/ejbModule/edu/kit/ipd/sdq/mediastore/ejb/cache/CacheImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.cache;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.naming.NamingException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.ICacheMaintenanceLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.ICacheMaintenanceRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownload;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadCacheLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadCacheRemote;

/**
 * This bean operates as a wrapper for a singleton to allow non-blocking fetching of data.
 */
@Stateless
public class CacheImpl extends BaseEJB implements IDownloadCacheRemote, IDownloadCacheLocal, ICacheMaintenanceRemote, ICacheMaintenanceLocal {

    /**
	 * 
	 */
	private static final long serialVersionUID = 1196355236963476398L;

	private IDownload next;

    @EJB
    private CacheSingleton cache;

    public CacheImpl() {
		super();
		ejbName = ""cache"";
	}
    
    @PostConstruct
    public void init() {
    	this.next = initRequiredInterface(""IDownload"", IDownload.class);
    }

    @Override
    public List<AudioFile> download(final List<Long> requestedAudioIDs, final List<Integer> bitrates,
            final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

//		System.out.println(""download via cache"");

        final List<Long> unCachedAudioIDs = new ArrayList<Long>();
        final List<Integer> unCachedBitrates = new ArrayList<Integer>();
        final List<AudioFile> result = new ArrayList<AudioFile>();

        // search for cached audios
        for (int i = 0; i < requestedAudioIDs.size(); i++) {
            final long id = requestedAudioIDs.get(i);
            final int bitrate = bitrates.get(i);
            final AudioFile cachedAudio = this.cache.getIfPresent(new IdAndBitrate(id, bitrate));
            if (cachedAudio == null) {
                // audio not cached
                unCachedAudioIDs.add(id);
                unCachedBitrates.add(bitrate);
            } else {
                // audio cached
                FileContent content = cachedAudio.getContent();
                String fileName = downloaderLogin +  cachedAudio.getFilename() + ""Cache"";
            	cachedAudio.setContent(content.convertIfNeeded(localCall, fileName, ""mp3""));
                result.add(cachedAudio);
            }
        }

        // get remaining audios
        if (unCachedAudioIDs.size() > 0) {
        	boolean localDownload = isLocal(""IDownload"");
            final List<AudioFile> unCachedAudios = this.next.download(unCachedAudioIDs, unCachedBitrates,
                    downloaderLogin, localDownload);

            // add remaining audios to cache and result list
            for (int i = 0; i < unCachedAudioIDs.size(); i++) {
                final long id = unCachedAudioIDs.get(i);
                final int bitrate = unCachedBitrates.get(i);
                final AudioFile unCachedAudio = unCachedAudios.get(i);
                
                
                FileContent content = unCachedAudio.getContent();
                String fileName = downloaderLogin +  unCachedAudio.getFilename() + ""Cache"";
            	unCachedAudio.setContent(content.convertIfNeeded(localCall, fileName, ""mp3""));

                this.cache.put(new IdAndBitrate(id, bitrate), unCachedAudio);
                result.add(unCachedAudio);
            }
        }

        return result;
    }

    @Override
    public void clear() {
        this.cache.clear();
    }
}"
Implementation/mediastore.ejb.audiowatermarking/src/edu/kit/ipd/sdq/mediastore/ejb/audiowatermarking/WavFile.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.audiowatermarking;

// Wav file IO class
// A.Greensted
// http://www.labbookpages.co.uk

// File format is based on the information from
// http://www.sonicspot.com/guide/wavefiles.html
// http://www.blitter.com/~russtopia/MIDI/~jglatt/tech/wave.htm

// Version 1.0

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintStream;

public class WavFile {
    private enum IOState {
        READING, WRITING, CLOSED
    };

    private final static int BUFFER_SIZE = 4096;

    private final static int FMT_CHUNK_ID = 0x20746D66;
    private final static int DATA_CHUNK_ID = 0x61746164;
    private final static int RIFF_CHUNK_ID = 0x46464952;
    private final static int RIFF_TYPE_ID = 0x45564157;

    private File file; // File that will be read from or written to
    private IOState ioState; // Specifies the IO State of the Wav File (used for snaity checking)
    private int bytesPerSample; // Number of bytes required to store a single sample
    private long numFrames; // Number of frames within the data section
    private FileOutputStream oStream; // Output stream used for writting data
    private FileInputStream iStream; // Input stream used for reading data
    private double floatScale; // Scaling factor used for int <-> float conversion
    private double floatOffset; // Offset factor used for int <-> float conversion
    private boolean wordAlignAdjust; // Specify if an extra byte at the end of the data chunk is
// required for word alignment

    // Wav Header
    private int numChannels; // 2 bytes unsigned, 0x0001 (1) to 0xFFFF (65,535)
    private long sampleRate; // 4 bytes unsigned, 0x00000001 (1) to 0xFFFFFFFF (4,294,967,295)
    // Although a java int is 4 bytes, it is signed, so need to use a long
    private int blockAlign; // 2 bytes unsigned, 0x0001 (1) to 0xFFFF (65,535)
    private int validBits; // 2 bytes unsigned, 0x0002 (2) to 0xFFFF (65,535)

    // Buffering
    private final byte[] buffer; // Local buffer used for IO
    private int bufferPointer; // Points to the current position in local buffer
    private int bytesRead; // Bytes read after last read into local buffer
    private long frameCounter; // Current number of frames read or written

    // Cannot instantiate WavFile directly, must either use newWavFile() or openWavFile()
    private WavFile() {
        this.buffer = new byte[BUFFER_SIZE];
    }

    public int getNumChannels() {
        return this.numChannels;
    }

    public long getNumFrames() {
        return this.numFrames;
    }

    public long getFramesRemaining() {
        return this.numFrames - this.frameCounter;
    }

    public long getSampleRate() {
        return this.sampleRate;
    }

    public int getValidBits() {
        return this.validBits;
    }

    public static WavFile newWavFile(final File file, final int numChannels, final long numFrames, final int validBits,
            final long sampleRate) throws IOException, WavFileException {
        // Instantiate new Wavfile and initialise
        final WavFile wavFile = new WavFile();
        wavFile.file = file;
        wavFile.numChannels = numChannels;
        wavFile.numFrames = numFrames;
        wavFile.sampleRate = sampleRate;
        wavFile.bytesPerSample = (validBits + 7) / 8;
        wavFile.blockAlign = wavFile.bytesPerSample * numChannels;
        wavFile.validBits = validBits;

        // Sanity check arguments
        if (numChannels < 1 || numChannels > 65535) {
            throw new WavFileException(""Illegal number of channels, valid range 1 to 65536"");
        }
        if (numFrames < 0) {
            throw new WavFileException(""Number of frames must be positive"");
        }
        if (validBits < 2 || validBits > 65535) {
            throw new WavFileException(""Illegal number of valid bits, valid range 2 to 65536"");
        }
        if (sampleRate < 0) {
            throw new WavFileException(""Sample rate must be positive"");
        }

        // Create output stream for writing data
        wavFile.oStream = new FileOutputStream(file);

        // Calculate the chunk sizes
        final long dataChunkSize = wavFile.blockAlign * numFrames;
        long mainChunkSize = 4 + // Riff Type
                8 + // Format ID and size
                16 + // Format data
                8 + // Data ID and size
                dataChunkSize;

        // Chunks must be word aligned, so if odd number of audio data bytes
        // adjust the main chunk size
        if (dataChunkSize % 2 == 1) {
            mainChunkSize += 1;
            wavFile.wordAlignAdjust = true;
        } else {
            wavFile.wordAlignAdjust = false;
        }

        // Set the main chunk size
        putLE(RIFF_CHUNK_ID, wavFile.buffer, 0, 4);
        putLE(mainChunkSize, wavFile.buffer, 4, 4);
        putLE(RIFF_TYPE_ID, wavFile.buffer, 8, 4);

        // Write out the header
        wavFile.oStream.write(wavFile.buffer, 0, 12);

        // Put format data in buffer
        final long averageBytesPerSecond = sampleRate * wavFile.blockAlign;

        putLE(FMT_CHUNK_ID, wavFile.buffer, 0, 4); // Chunk ID
        putLE(16, wavFile.buffer, 4, 4); // Chunk Data Size
        putLE(1, wavFile.buffer, 8, 2); // Compression Code (Uncompressed)
        putLE(numChannels, wavFile.buffer, 10, 2); // Number of channels
        putLE(sampleRate, wavFile.buffer, 12, 4); // Sample Rate
        putLE(averageBytesPerSecond, wavFile.buffer, 16, 4); // Average Bytes Per Second
        putLE(wavFile.blockAlign, wavFile.buffer, 20, 2); // Block Align
        putLE(validBits, wavFile.buffer, 22, 2); // Valid Bits

        // Write Format Chunk
        wavFile.oStream.write(wavFile.buffer, 0, 24);

        // Start Data Chunk
        putLE(DATA_CHUNK_ID, wavFile.buffer, 0, 4); // Chunk ID
        putLE(dataChunkSize, wavFile.buffer, 4, 4); // Chunk Data Size

        // Write Format Chunk
        wavFile.oStream.write(wavFile.buffer, 0, 8);

        // Calculate the scaling factor for converting to a normalised double
        if (wavFile.validBits > 8) {
            // If more than 8 validBits, data is signed
            // Conversion required multiplying by magnitude of max positive value
            wavFile.floatOffset = 0;
            wavFile.floatScale = Long.MAX_VALUE >> (64 - wavFile.validBits);
        } else {
            // Else if 8 or less validBits, data is unsigned
            // Conversion required dividing by max positive value
            wavFile.floatOffset = 1;
            wavFile.floatScale = 0.5 * ((1 << wavFile.validBits) - 1);
        }

        // Finally, set the IO State
        wavFile.bufferPointer = 0;
        wavFile.bytesRead = 0;
        wavFile.frameCounter = 0;
        wavFile.ioState = IOState.WRITING;

        return wavFile;
    }

    public static WavFile openWavFile(final File file) throws IOException, WavFileException {
        // Instantiate new Wavfile and store the file reference
        final WavFile wavFile = new WavFile();
        wavFile.file = file;

        // Create a new file input stream for reading file data
        wavFile.iStream = new FileInputStream(file);

        // Read the first 12 bytes of the file
        int bytesRead = wavFile.iStream.read(wavFile.buffer, 0, 12);
        if (bytesRead != 12) {
            throw new WavFileException(""Not enough wav file bytes for header"");
        }

        // Extract parts from the header
        final long riffChunkID = getLE(wavFile.buffer, 0, 4);
        long chunkSize = getLE(wavFile.buffer, 4, 4);
        final long riffTypeID = getLE(wavFile.buffer, 8, 4);

        // Check the header bytes contains the correct signature
        if (riffChunkID != RIFF_CHUNK_ID) {
            throw new WavFileException(""Invalid Wav Header data, incorrect riff chunk ID"");
        }
        if (riffTypeID != RIFF_TYPE_ID) {
            throw new WavFileException(""Invalid Wav Header data, incorrect riff type ID"");
        }

        // Check that the file size matches the number of bytes listed in header
        if (file.length() != chunkSize + 8) {
            throw new WavFileException(""Header chunk size ("" + chunkSize + "") does not match file size (""
                    + file.length() + "")"");
        }

        boolean foundFormat = false;
        boolean foundData = false;

        // Search for the Format and Data Chunks
        while (true) {
            // Read the first 8 bytes of the chunk (ID and chunk size)
            bytesRead = wavFile.iStream.read(wavFile.buffer, 0, 8);
            if (bytesRead == -1) {
                throw new WavFileException(""Reached end of file without finding format chunk"");
            }
            if (bytesRead != 8) {
                throw new WavFileException(""Could not read chunk header"");
            }

            // Extract the chunk ID and Size
            final long chunkID = getLE(wavFile.buffer, 0, 4);
            chunkSize = getLE(wavFile.buffer, 4, 4);

            // Word align the chunk size
            // chunkSize specifies the number of bytes holding data. However,
            // the data should be word aligned (2 bytes) so we need to calculate
            // the actual number of bytes in the chunk
            long numChunkBytes = (chunkSize % 2 == 1) ? chunkSize + 1 : chunkSize;

            if (chunkID == FMT_CHUNK_ID) {
                // Flag that the format chunk has been found
                foundFormat = true;

                // Read in the header info
                bytesRead = wavFile.iStream.read(wavFile.buffer, 0, 16);

                // Check this is uncompressed data
                final int compressionCode = (int) getLE(wavFile.buffer, 0, 2);
                if (compressionCode != 1) {
                    throw new WavFileException(""Compression Code "" + compressionCode + "" not supported"");
                }

                // Extract the format information
                wavFile.numChannels = (int) getLE(wavFile.buffer, 2, 2);
                wavFile.sampleRate = getLE(wavFile.buffer, 4, 4);
                wavFile.blockAlign = (int) getLE(wavFile.buffer, 12, 2);
                wavFile.validBits = (int) getLE(wavFile.buffer, 14, 2);

                if (wavFile.numChannels == 0) {
                    throw new WavFileException(""Number of channels specified in header is equal to zero"");
                }
                if (wavFile.blockAlign == 0) {
                    throw new WavFileException(""Block Align specified in header is equal to zero"");
                }
                if (wavFile.validBits < 2) {
                    throw new WavFileException(""Valid Bits specified in header is less than 2"");
                }
                if (wavFile.validBits > 64) {
                    throw new WavFileException(
                            ""Valid Bits specified in header is greater than 64, this is greater than a long can hold"");
                }

                // Calculate the number of bytes required to hold 1 sample
                wavFile.bytesPerSample = (wavFile.validBits + 7) / 8;
                if (wavFile.bytesPerSample * wavFile.numChannels != wavFile.blockAlign) {
                    throw new WavFileException(
                            ""Block Align does not agree with bytes required for validBits and number of channels"");
                }

                // Account for number of format bytes and then skip over
                // any extra format bytes
                numChunkBytes -= 16;
                if (numChunkBytes > 0) {
                    wavFile.iStream.skip(numChunkBytes);
                }
            } else if (chunkID == DATA_CHUNK_ID) {
                // Check if we've found the format chunk,
                // If not, throw an exception as we need the format information
                // before we can read the data chunk
                if (foundFormat == false) {
                    throw new WavFileException(""Data chunk found before Format chunk"");
                }

                // Check that the chunkSize (wav data length) is a multiple of the
                // block align (bytes per frame)
                if (chunkSize % wavFile.blockAlign != 0) {
                    throw new WavFileException(""Data Chunk size is not multiple of Block Align"");
                }

                // Calculate the number of frames
                wavFile.numFrames = chunkSize / wavFile.blockAlign;

                // Flag that we've found the wave data chunk
                foundData = true;

                break;
            } else {
                // If an unknown chunk ID is found, just skip over the chunk data
                wavFile.iStream.skip(numChunkBytes);
            }
        }

        // Throw an exception if no data chunk has been found
        if (foundData == false) {
            throw new WavFileException(""Did not find a data chunk"");
        }

        // Calculate the scaling factor for converting to a normalised double
        if (wavFile.validBits > 8) {
            // If more than 8 validBits, data is signed
            // Conversion required dividing by magnitude of max negative value
            wavFile.floatOffset = 0;
            wavFile.floatScale = 1 << (wavFile.validBits - 1);
        } else {
            // Else if 8 or less validBits, data is unsigned
            // Conversion required dividing by max positive value
            wavFile.floatOffset = -1;
            wavFile.floatScale = 0.5 * ((1 << wavFile.validBits) - 1);
        }

        wavFile.bufferPointer = 0;
        wavFile.bytesRead = 0;
        wavFile.frameCounter = 0;
        wavFile.ioState = IOState.READING;

        return wavFile;
    }

    // Get and Put little endian data from local buffer
    // ------------------------------------------------
    private static long getLE(final byte[] buffer, int pos, int numBytes) {
        numBytes--;
        pos += numBytes;

        long val = buffer[pos] & 0xFF;
        for (int b = 0; b < numBytes; b++) {
            val = (val << 8) + (buffer[--pos] & 0xFF);
        }

        return val;
    }

    private static void putLE(long val, final byte[] buffer, int pos, final int numBytes) {
        for (int b = 0; b < numBytes; b++) {
            buffer[pos] = (byte) (val & 0xFF);
            val >>= 8;
            pos++;
        }
    }

    // Sample Writing and Reading
    // --------------------------
    private void writeSample(long val) throws IOException {
        for (int b = 0; b < this.bytesPerSample; b++) {
            if (this.bufferPointer == BUFFER_SIZE) {
                this.oStream.write(this.buffer, 0, BUFFER_SIZE);
                this.bufferPointer = 0;
            }

            this.buffer[this.bufferPointer] = (byte) (val & 0xFF);
            val >>= 8;
            this.bufferPointer++;
        }
    }

    private long readSample() throws IOException, WavFileException {
        long val = 0;

        for (int b = 0; b < this.bytesPerSample; b++) {
            if (this.bufferPointer == this.bytesRead) {
                final int read = this.iStream.read(this.buffer, 0, BUFFER_SIZE);
                if (read == -1) {
                    throw new WavFileException(""Not enough data available"");
                }
                this.bytesRead = read;
                this.bufferPointer = 0;
            }

            int v = this.buffer[this.bufferPointer];
            if (b < this.bytesPerSample - 1 || this.bytesPerSample == 1) {
                v &= 0xFF;
            }
            val += v << (b * 8);

            this.bufferPointer++;
        }

        return val;
    }

    // Integer
    // -------
    public int readFrames(final int[] sampleBuffer, final int numFramesToRead) throws IOException, WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final int[] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[offset] = (int) this.readSample();
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int readFrames(final int[][] sampleBuffer, final int numFramesToRead) throws IOException, WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final int[][] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[c][offset] = (int) this.readSample();
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int writeFrames(final int[] sampleBuffer, final int numFramesToWrite) throws IOException, WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final int[] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample(sampleBuffer[offset]);
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    public int writeFrames(final int[][] sampleBuffer, final int numFramesToWrite) throws IOException, WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final int[][] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample(sampleBuffer[c][offset]);
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    // Long
    // ----
    public int readFrames(final long[] sampleBuffer, final int numFramesToRead) throws IOException, WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final long[] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[offset] = this.readSample();
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int readFrames(final long[][] sampleBuffer, final int numFramesToRead) throws IOException, WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final long[][] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[c][offset] = this.readSample();
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int writeFrames(final long[] sampleBuffer, final int numFramesToWrite) throws IOException, WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final long[] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample(sampleBuffer[offset]);
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    public int writeFrames(final long[][] sampleBuffer, final int numFramesToWrite) throws IOException,
            WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final long[][] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample(sampleBuffer[c][offset]);
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    // Double
    // ------
    public int readFrames(final double[] sampleBuffer, final int numFramesToRead) throws IOException, WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final double[] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[offset] = this.floatOffset + this.readSample() / this.floatScale;
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int readFrames(final double[][] sampleBuffer, final int numFramesToRead) throws IOException,
            WavFileException {
        return this.readFrames(sampleBuffer, 0, numFramesToRead);
    }

    public int readFrames(final double[][] sampleBuffer, int offset, final int numFramesToRead) throws IOException,
            WavFileException {
        if (this.ioState != IOState.READING) {
            throw new IOException(""Cannot read from WavFile instance"");
        }

        for (int f = 0; f < numFramesToRead; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                sampleBuffer[c][offset] = this.floatOffset + this.readSample() / this.floatScale;
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToRead;
    }

    public int writeFrames(final double[] sampleBuffer, final int numFramesToWrite) throws IOException,
            WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final double[] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample((long) (this.floatScale * (this.floatOffset + sampleBuffer[offset])));
                offset++;
            }

            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    public int writeFrames(final double[][] sampleBuffer, final int numFramesToWrite) throws IOException,
            WavFileException {
        return this.writeFrames(sampleBuffer, 0, numFramesToWrite);
    }

    public int writeFrames(final double[][] sampleBuffer, int offset, final int numFramesToWrite) throws IOException,
            WavFileException {
        if (this.ioState != IOState.WRITING) {
            throw new IOException(""Cannot write to WavFile instance"");
        }

        for (int f = 0; f < numFramesToWrite; f++) {
            if (this.frameCounter == this.numFrames) {
                return f;
            }

            for (int c = 0; c < this.numChannels; c++) {
                this.writeSample((long) (this.floatScale * (this.floatOffset + sampleBuffer[c][offset])));
            }

            offset++;
            this.frameCounter++;
        }

        return numFramesToWrite;
    }

    public void close() throws IOException {
        // Close the input stream and set to null
        if (this.iStream != null) {
            this.iStream.close();
            this.iStream = null;
        }

        if (this.oStream != null) {
            // Write out anything still in the local buffer
            if (this.bufferPointer > 0) {
                this.oStream.write(this.buffer, 0, this.bufferPointer);
            }

            // If an extra byte is required for word alignment, add it to the end
            if (this.wordAlignAdjust) {
                this.oStream.write(0);
            }

            // Close the stream and set to null
            this.oStream.close();
            this.oStream = null;
        }

        // Flag that the stream is closed
        this.ioState = IOState.CLOSED;
    }

    public void display() {
        this.display(System.out);
    }

    public void display(final PrintStream out) {
        out.printf(""File: %s\n"", this.file);
        out.printf(""Channels: %d, Frames: %d\n"", this.numChannels, this.numFrames);
        out.printf(""IO State: %s\n"", this.ioState);
        out.printf(""Sample Rate: %d, Block Align: %d\n"", this.sampleRate, this.blockAlign);
        out.printf(""Valid Bits: %d, Bytes per sample: %d\n"", this.validBits, this.bytesPerSample);
    }

    public static void main(final String[] args) {
        if (args.length < 1) {
            System.err.println(""Must supply filename"");
            System.exit(1);
        }

        try {
            for (final String filename : args) {
                final WavFile readWavFile = openWavFile(new File(filename));
//				readWavFile.display();

                final long numFrames = readWavFile.getNumFrames();
                final int numChannels = readWavFile.getNumChannels();
                final int validBits = readWavFile.getValidBits();
                final long sampleRate = readWavFile.getSampleRate();

                final WavFile writeWavFile = newWavFile(new File(""out.wav""), numChannels, numFrames, validBits,
                        sampleRate);

                final int BUF_SIZE = 5001;

//				int[] buffer = new int[BUF_SIZE * numChannels];
//				long[] buffer = new long[BUF_SIZE * numChannels];
                final double[] buffer = new double[BUF_SIZE * numChannels];

                int framesRead = 0;
//				int framesWritten = 0;

                do {
                    framesRead = readWavFile.readFrames(buffer, BUF_SIZE);
//					framesWritten = writeWavFile.writeFrames(buffer, BUF_SIZE);
                    writeWavFile.writeFrames(buffer, BUF_SIZE);
//					System.out.printf(""%d %d\n"", framesRead, framesWritten);
                } while (framesRead != 0);

                readWavFile.close();
                writeWavFile.close();
            }

            final WavFile writeWavFile = newWavFile(new File(""out2.wav""), 1, 10, 23, 44100);
            final double[] buffer = new double[10];
            writeWavFile.writeFrames(buffer, 10);
            writeWavFile.close();
        } catch (final Exception e) {
            System.err.println(e);
            e.printStackTrace();
        }
    }
}"
Implementation/mediastore.ejb.audiowatermarking/src/edu/kit/ipd/sdq/mediastore/ejb/audiowatermarking/WavFileException.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.audiowatermarking;

public class WavFileException extends Exception {
    private static final long serialVersionUID = -2472979745308520788L;

    public WavFileException() {
        super();
    }

    public WavFileException(final String message) {
        super(message);
    }

    public WavFileException(final String message, final Throwable cause) {
        super(message, cause);
    }

    public WavFileException(final Throwable cause) {
        super(cause);
    }
}"
Implementation/mediastore.ejb.audiowatermarking/src/edu/kit/ipd/sdq/mediastore/ejb/audiowatermarking/AudioWatermarkingImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.audiowatermarking;


import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.ListIterator;

import javax.annotation.PostConstruct;
import javax.ejb.Stateless;
import javax.naming.NamingException;

import org.apache.commons.lang3.SystemUtils;
import org.jaudiotagger.audio.exceptions.CannotReadException;
import org.jaudiotagger.audio.exceptions.CannotWriteException;
import org.jaudiotagger.audio.exceptions.InvalidAudioFrameException;
import org.jaudiotagger.audio.exceptions.ReadOnlyFileException;
import org.jaudiotagger.tag.TagException;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.ConversionException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownload;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadAudioWatermarkingLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadAudioWatermarkingRemote;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;
import edu.kit.ipd.sdq.mediastore.basic.utils.LameUtil;

/**
 * Session Bean implementation class Watermarking. This program uses third party free and opensource
 * APIs and software - API to manipulate wav files :
 * http://www.labbookpages.co.uk/audio/javaWavFiles.html - API to manipulate mp3 tags :
 * http://www.jthink.net/jaudiotagger/ - LAME to encode/decode audio files
 *
 * @author Amine Kechaou
 */

@Stateless
public class AudioWatermarkingImpl extends BaseEJB implements IDownloadAudioWatermarkingRemote, IDownloadAudioWatermarkingLocal {

    private IDownload next;

    private final static double secPerBit = 0.1; // number of seconds required for each bit
    private final static int hf = 10000; // high frequency in Hz
    private final static int lf = 1; // low frequency in Hz
    private final static double amplitude = 0.0001; // amplitude of the watermark signal. At this amplitude the signal is not audible

    /**
     * Default constructor.
     */
    public AudioWatermarkingImpl() {
    	super();
    	ejbName = ""audiowatermarking"";
    }

    @PostConstruct
    public void init() {
    	this.next = initRequiredInterface(""IDownload"", IDownload.class);
    }

    /**
     * This method watermarks all files for download and return them as a list of AudioFile with the
     * desired bitrate
     */
    @Override
    public List<AudioFile> download(final List<Long> requestedAudioIDs,
            final List<Integer> bitrates, final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

        if (SystemUtils.IS_OS_WINDOWS) {
            try {
                LameUtil.initLame();
            } catch (final ConversionException e) {
                System.out.println(e.getMessage());
                e.printStackTrace();
            }
        }

        final List<AudioFile> result = new ArrayList<AudioFile>();
        final List<AudioFile> fileList = this.next.download(requestedAudioIDs,
                bitrates, downloaderLogin, isLocal(""IDownload"")); // fetch files from database
        final ListIterator<AudioFile> audioFileIterator = fileList.listIterator(); // AudioFile iterator
        final ListIterator<Integer> bitrateIterator = bitrates.listIterator(); // Integer iterator

        while (audioFileIterator.hasNext() && bitrateIterator.hasNext()) { // watermark each file then return the resulting list
            final AudioFile currentAudioFile = audioFileIterator.next();
            final AudioFileInfo info = currentAudioFile.getInfo(); // save file info for later use
            final Integer bitrate = bitrateIterator.next();
            String watermarkedFilePath = """";
            final String inputPath = FSUtil.getTempFileName(currentAudioFile.getId() + ""[Input]"", ""mp3""); // create temporary mp3 file

            try {
                FSUtil.writeToFile(currentAudioFile.getContent(), inputPath); // write the content of the current file in the temp file
            } catch (final FileNotFoundException e) {
                System.out.println(""Writing bytes to file failed : temp file not found"");
                e.printStackTrace();
            } catch (final IOException e) {
                System.out.println(""Writing bytes to file failed : IO Error"");
                e.printStackTrace();
            }

            // This section saves the mp3 tags for later use using jaudiotagger api
            org.jaudiotagger.audio.AudioFile inputFile = new org.jaudiotagger.audio.AudioFile();
            try {
                inputFile = org.jaudiotagger.audio.AudioFileIO.read(new File(inputPath));
            } catch (CannotReadException | IOException | TagException | ReadOnlyFileException
                    | InvalidAudioFrameException e1) {
                e1.printStackTrace();
            }
            final org.jaudiotagger.tag.Tag tag = inputFile.getTag();

            // watermark current file, with the downloader login and convert the song to the desired bitrate
            try {
                watermarkedFilePath = this.watermark(inputPath, currentAudioFile, downloaderLogin, bitrate.intValue());
                Files.delete(Paths.get(inputPath)); //delete temporary input file
            } catch (final ConversionException e) {
                System.out.println(e.getMessage());
                e.printStackTrace();
            } catch (IOException e) {
				e.printStackTrace();
			}

            // This section writes the mp3 tags on the output mp3 file, due to their loss during the conversion to wav format
            org.jaudiotagger.audio.AudioFile outputFile = new org.jaudiotagger.audio.AudioFile();
            try {
                outputFile = org.jaudiotagger.audio.AudioFileIO.read(new File(watermarkedFilePath));
            } catch (CannotReadException | IOException | TagException | ReadOnlyFileException
                    | InvalidAudioFrameException e1) {
                e1.printStackTrace();
            }
            outputFile.setTag(tag);
            try {
                outputFile.commit();
            } catch (final CannotWriteException e1) {
                e1.printStackTrace();
            }

            
            info.setBitrate(bitrate); // change the info bitrate to the current bitrate
            
            FileContent content = null;


            final Path path = Paths.get(watermarkedFilePath);
            if (!localCall) {
                byte[] data = null;
                try {
                    data = Files.readAllBytes(path);
                } catch (final IOException e) {
                    System.out.println(""Reading bytes from watermarked file "" + currentAudioFile.getTitle() + "" failed"");
                    e.printStackTrace();
                }
                content = new FileContentRemote(data);
                
	            try {
					Files.delete(path);
				} catch (IOException e) {
					e.printStackTrace();
				}
            }
            else {
            	content = new FileContentLocal(path);
            }
            
            
            final AudioFile watermarkedFile = new AudioFile(info, content); // create new AudioFile containing the output data and info
            result.add(watermarkedFile);
        }

        return result;
    }

    /**
     * This function watermarks a file and sets its bitrate
     *
     * @param inputPath
     *            path of the input mp3 file
     * @param file
     *            input AudioFile
     * @param downloaderLogin
     *            Downloader login : this string will be hidden inside the song
     * @param bitrate
     *            desired bitrate
     * @return path of the output mp3 file
     * @throws ConversionException
     *             if the conversion fails
     */
    private String watermark(final String inputPath, final AudioFile file,
            final String downloaderLogin, final int bitrate) throws ConversionException {

        final File inputWav = new File(FSUtil.getTempFileName(file.getId() + ""input"", ""wav"")); // create new temporary IO wav files
        final File outputWav = new File(FSUtil.getTempFileName(file.getId() + ""output"", ""wav""));

        if (!LameUtil.decode(inputPath, inputWav.getAbsolutePath())) {
            throw new ConversionException(""Failed to convert file "" + inputPath + "" to wav format"");
        }
        // Reading section
        WavFile input = null;
        WavFile output = null;
        long sampleRate = 44100; // default sample rate
        long numFrames;
        try {
            input = WavFile.openWavFile(inputWav);
            sampleRate = input.getSampleRate(); // Samples per second
            numFrames = input.getNumFrames();
            output = WavFile.newWavFile(outputWav, 2, numFrames, 16, sampleRate); // create the output wav file with the same sampleRate and number of frames of the input file
        } catch (IOException | WavFileException e) {
            e.printStackTrace();
        }

        // Create a buffer of 100 frames with 2 channels
        final int bufferSize = 100;
        final double[][] buffer = new double[2][bufferSize];

        int framesRead = 0;
        long frameCounter = 0;

        final String bs = this.getBinaryString(downloaderLogin); // convert the downloaderLogin into a binary string of 1s and 0s
        do {
            // Read frames into buffer
            try {
                framesRead = input.readFrames(buffer, bufferSize);
            } catch (IOException | WavFileException e) {
                System.out.println(""Reading frames from input wav file "" + inputPath + "" failed"");
                e.printStackTrace();
            }

            final long remaining = output.getFramesRemaining();
            final int toWrite = (remaining > bufferSize) ? bufferSize : (int) remaining; // determines the number of frames to be written : bufferSize or less, if the remaining frames are less than bufferSize

            for (int s = 0; s < toWrite; s++, frameCounter++) {
                final double t = (double) frameCounter / sampleRate; // time position : frameCounter's unit is ""frame"", sampleRate is frame per second. Thus the quotient is expressed in seconds
                final double value = Math.sin(2.0 * Math.PI * this.getFrequency(t, bs) * t); // add the value of the sine wave to current time position with the calculated frequency
                buffer[0][s] = buffer[0][s] + amplitude * value;
                buffer[1][s] = buffer[1][s] + amplitude * value;
            }
            try {
                output.writeFrames(buffer, framesRead);
            } catch (IOException | WavFileException e) {
                System.out.println(""Writing frames to output wav file "" + inputPath + "" failed"");
                e.printStackTrace();
            }
        } while (framesRead != 0); // until all frames are read

        try {
            input.close();
            output.close();
        } catch (final IOException e) {
            System.out.println(""Closing input/output wav files failed"");
            e.printStackTrace();
        }

        final String outputPath = FSUtil.getTempFileName(file.getId() + ""[Output]"", ""mp3""); // create temporary output mp3 file

        if (!LameUtil.encode(outputWav.getAbsolutePath(), outputPath, bitrate)) { // wav file to mp3 and set its bitrate
            throw new ConversionException(""Failed to convert file "" + inputPath + "" from wav back to mp3 format"");
        }

        // delete IO wav files
        System.out.println(""Deleting temporary input wav file "" + inputWav.getAbsolutePath() + "" returned : ""
                + inputWav.delete());
        System.out.println(""Deleting temporary output wav file "" + inputWav.getAbsolutePath() + "" returned : ""
                + outputWav.delete());

        return outputPath; // return the output mp3 file path
    }

    /**
     * Converts a string to binary form
     * @param s string to be converted
     * @return binary representation of the string
     */
    private String getBinaryString(final String s) {
        String bs = """";
        for (int i = 0; i < s.length(); ++i) {
            final int c = s.charAt(i);
            String bin = Integer.toBinaryString(c);
            while (bin.length() < 8) { // add padding
                bin = ""0"" + bin;
            }
            bs = bs + bin;
        }
        return bs;
    }

    /**
     * Calculates the frequency corresponding to a binary String
     * @param t time position
     * @param bs binary string
     * @return frequency of the given bit
     * 
     */
    private int getFrequency(final double t, final String bs) {
        final int index = ((int) (t / secPerBit)) % bs.length(); // calculate current index
        final int f = (bs.charAt(index) == '0') ? lf : hf; // if bit = 0, f = low frequency, otherwise f = high frequency
        return f;
    }
}"
Implementation/mediastore.ejb.mediaaccess/src/edu/kit/ipd/sdq/mediastore/ejb/mediaaccess/MediaAccessImpl.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.mediaaccess;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.List;

import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.naming.NamingException;

import org.apache.commons.io.FileUtils;

import edu.kit.ipd.sdq.mediastore.basic.BaseEJB;
import edu.kit.ipd.sdq.mediastore.basic.config.GlobalConstantsContainer;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContent;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentLocal;
import edu.kit.ipd.sdq.mediastore.basic.data.FileContentRemote;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedUploadException;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadMediaAccessLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IDownloadMediaAccessRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaAccessLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaAccessMaintenanceLocal;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaAccessMaintenanceRemote;
import edu.kit.ipd.sdq.mediastore.basic.interfaces.IMediaAccessRemote;
import edu.kit.ipd.sdq.mediastore.basic.utils.FSUtil;

/**
 *
 * @author Anastasia
 *
 */
/*
 * Die Audios werden in Ordner unter dem Name FILE_MAIN_DIR/Artist/Album des Files/Filename
 */

@Stateless
public class MediaAccessImpl extends BaseEJB implements IMediaAccessRemote, IMediaAccessLocal, IDownloadMediaAccessRemote, IDownloadMediaAccessLocal, IMediaAccessMaintenanceRemote, IMediaAccessMaintenanceLocal {

	private static final long serialVersionUID = -7677084793452622019L;
	@EJB
    DbManager dbManager;

	public MediaAccessImpl() {
		super();
		ejbName = ""mediaaccess"";
	}
    
    @Override
    public Long upload(final AudioFile file)  throws FailedUploadException, RemoteException {

        // Create Ordner, falls sie nicht vorhanden sind
        final StringBuilder pathBuilder = new StringBuilder();
        pathBuilder.append(GlobalConstantsContainer.getFileDir()).append(file.getArtist()).append(""\\"")
                .append(file.getAlbum());

        final File f = new File(pathBuilder.toString());
        f.mkdirs();

        pathBuilder.append(""\\"").append(file.getFilename());

        final String filePath = pathBuilder.toString();
        
        FileContent content = file.getContent();
        try {
            FSUtil.writeToFile(content, filePath);
            if (content.isLocal()) {
            	Files.deleteIfExists(((FileContentLocal) content).getPath());
            }
            return this.dbManager.saveAudioFile(file);
        } catch (final IOException e) {
            throw new FailedUploadException(file.getFilename(), e);
        }
    }

    @Override
    public List<AudioFileInfo> getFileList() {

        return this.dbManager.getAllAudios();
    }

    @Override
    public List<AudioFile> download(final List<Long> requestedAudioIDs, final List<Integer> bitrates,
            final String downloaderLogin, final boolean localCall) throws FailedDownloadException, NamingException {

        final String root = GlobalConstantsContainer.getFileDir();
        final List<AudioFile> audioFiles = new ArrayList<AudioFile>();

        for (final Long id : requestedAudioIDs) {
            final AudioFileInfo audioFileInfo = this.dbManager.getAudioByID(id);

            final StringBuilder pathBuilder = new StringBuilder();
            pathBuilder.append(root)
            .append(audioFileInfo.getArtist())
            .append(""\\"")
            .append(audioFileInfo.getAlbum())
            .append(""\\"")
            .append(audioFileInfo.getFilename());

            final String filePath = pathBuilder.toString();

            audioFiles.add(new AudioFile(audioFileInfo, this.getFileContent(filePath, localCall)));
        }

        return audioFiles;
    }


    private FileContent getFileContent(final String filePath, boolean localCall) throws FailedDownloadException {
        if (localCall) {
        	Path source = Paths.get(filePath);
        	Path target = Paths.get(FSUtil.getTempFileName(source.getFileName().toString(), ""mp3""));
        	try {
				Files.copy(source, target);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
        	return new FileContentLocal(target);
        }
        else {
            try {
                return new FileContentRemote(FSUtil.readFileToMem(filePath));
            } catch (final IOException e) {
                throw new FailedDownloadException(filePath);
            }
        }
    }

    @Override
    public void removeAllData() {
        this.dbManager.clearTable();

        final File audioFileDir = new File(GlobalConstantsContainer.getFileDir());
        try {
            FileUtils.cleanDirectory(audioFileDir);
        } catch (final IOException e) {
            System.out.println(""An error occured while removing audio files"");
            e.printStackTrace();
        }
    }

    @Override
    public boolean trimToPayload(final long payloadUserId, final int payloadSize) {

        final List<AudioFileInfo> fileList = this.getFileList();
        for (final AudioFileInfo audio : fileList) {
            if (audio.getUploader() != payloadUserId) {
                final StringBuilder pathBuilder = new StringBuilder();
                pathBuilder.append(GlobalConstantsContainer.getFileDir()).append(audio.getArtist()).append(""\\"")
                        .append(audio.getAlbum()).append(""\\"").append(audio.getFilename());
                new File(pathBuilder.toString()).delete();
            }
        }

        this.dbManager.clearExceptFromUser(payloadUserId);
        final long audioCount = this.dbManager.getAudioCount();
        if (audioCount == payloadSize) {
            return true;
        } else {
            return false;
        }
    }
}"
Implementation/mediastore.ejb.mediaaccess/src/edu/kit/ipd/sdq/mediastore/ejb/mediaaccess/DbManager.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.mediaaccess;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

import edu.kit.ipd.sdq.mediastore.basic.data.AudioFile;
import edu.kit.ipd.sdq.mediastore.basic.data.AudioFileInfo;
import edu.kit.ipd.sdq.mediastore.basic.exceptions.FailedDownloadException;

/**
 * @author Anastasia @date: 06.12.2014
 */
@Stateless
public class DbManager {

    @PersistenceContext(name = ""Mediastore"")
    private EntityManager em;

    public <T extends AudioFile> Long saveAudioFile(final T file) {
//        System.out.println(""DbManager.saveAudioFile()"");

        final Audio audio = new Audio();
        audio.setTitle(file.getTitle());
        audio.setArtist(file.getArtist());
        audio.setAlbum(file.getAlbum());
        audio.setBitrate(file.getBitrate());
        audio.setGenre(file.getGenre());
        audio.setReleaseyear(file.getReleaseyear());
        audio.setUserId(file.getUploader());

        this.em.persist(audio);
        this.em.flush();

        return audio.getId();
    }

    public List<AudioFileInfo> getAllAudios() {

        final List<AudioFileInfo> listInfos = new ArrayList<AudioFileInfo>();

        final List<Audio> audies = this.em.createNamedQuery(""findAll"", Audio.class).getResultList();
        for (final Audio audio : audies) {
            listInfos.add(new AudioFileInfo(audio.getId(), audio.getAlbum(), audio.getArtist(), audio.getBitrate(),
                    audio.getGenre(), audio.getReleaseyear(), audio.getTitle(), audio.getUserId()));
        }

        return listInfos;
    }

    public AudioFileInfo getAudioByID(final Long id) throws FailedDownloadException {

        final List<Audio> audies = this.em.createNamedQuery(""findByID"", Audio.class).setParameter(""id"", id)
                .getResultList();

        if (audies == null || audies.size() == 0) {
            throw new FailedDownloadException(""Audio File wurde in DatenBank nicht gefunden."");
        }

        final Audio audio = audies.get(0);
        final AudioFileInfo audioInfos = new AudioFileInfo(audio.getId(), audio.getAlbum(), audio.getArtist(),
                audio.getBitrate(), audio.getGenre(), audio.getReleaseyear(), audio.getTitle(), audio.getUserId());

        return audioInfos;
    }

    public void clearTable() {
        this.em.createNamedQuery(""clear"", Audio.class).executeUpdate();
    }

    public void clearExceptFromUser(final long userId) {
        this.em.createNamedQuery(""clearExceptFromUser"").setParameter(""userId"", userId).executeUpdate();
    }

    public long getAudioCount() {
        final Long singleResult = this.em.createNamedQuery(""getCount"", Long.class).getSingleResult();
        final long count = singleResult;
        return count;
    }
}"
Implementation/mediastore.ejb.mediaaccess/src/edu/kit/ipd/sdq/mediastore/ejb/mediaaccess/Audio.java,"/**
 * Media Store V3
 * Copyright (C) 2015 Software Design and Quality Group (SDQ), KIT, Germany
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package edu.kit.ipd.sdq.mediastore.ejb.mediaaccess;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.TableGenerator;

/**
 * The persistent class for the AUDIO database table.
 */
@Entity
@TableGenerator(name = ""audio"")
@NamedQueries({ @NamedQuery(name = ""clearExceptFromUser"", query = ""DELETE FROM Audio a WHERE a.userId != :userId""),
        @NamedQuery(name = ""clear"", query = ""DELETE FROM Audio""),
        @NamedQuery(name = ""findAll"", query = ""SELECT e FROM Audio e""),
        @NamedQuery(name = ""findByTitle"", query = ""SELECT e FROM Audio e WHERE e.title = :title""),
        @NamedQuery(name = ""findByID"", query = ""SELECT e FROM Audio e WHERE e.id = :id""),
        @NamedQuery(name = ""getCount"", query = ""SELECT count(a) FROM Audio a"") })
public class Audio implements Serializable {

    private static final long serialVersionUID = -1655097640656971957L;

    @Id
    @GeneratedValue(strategy = GenerationType.TABLE)
    private Long id;

    private String album;

    @Column(nullable = false)
    private String artist;

    @Column(nullable = false)
    private Integer bitrate;

    private String genre;

    private Integer releaseyear;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false)
    private Long userId;

    public Audio() {
    }

    public Long getId() {
        return this.id;
    }

    public void setId(final Long id) {
        this.id = id;
    }

    public String getAlbum() {
        return this.album;
    }

    public void setAlbum(final String album) {
        this.album = album;
    }

    public String getArtist() {
        return this.artist;
    }

    public void setArtist(final String artist) {
        this.artist = artist;
    }

    public Integer getBitrate() {
        return this.bitrate;
    }

    public void setBitrate(final Integer bitrate) {
        this.bitrate = bitrate;
    }

    public String getGenre() {
        return this.genre;
    }

    public void setGenre(final String genre) {
        this.genre = genre;
    }

    public Integer getReleaseyear() {
        return this.releaseyear;
    }

    public void setReleaseyear(final Integer releaseyear) {
        this.releaseyear = releaseyear;
    }

    public String getTitle() {
        return this.title;
    }

    public void setTitle(final String title) {
        this.title = title;
    }

    public Long getUserId() {
        return this.userId;
    }

    public void setUserId(final Long userId) {
        this.userId = userId;
    }

}"
